{% extends 'uploader/tiktok/base.html' %}
{% load static %}

{% block title %}TikTok Start Upload{% endblock %}

{% block extra_css %}
<style>
    .btn-primary { background: linear-gradient(135deg, #ff0050 0%, #ff4081 100%); border: none; }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-outline-secondary:hover { background-color: rgba(0,0,0,0.04); }
    .progress-bar { background: linear-gradient(90deg, #ff0050, #ff4081); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0">Start Upload</h3>
        <div>
            <a href="{% url 'tiktok_videos_prepare' %}" class="btn btn-outline-secondary me-2">‚Üê Back</a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <p class="text-muted">This will start uploading prepared videos using the current configuration.</p>
            <button class="btn btn-primary" id="start-btn">
                <i class="bi bi-play-fill me-2"></i>Start Upload
            </button>
            <button class="btn btn-outline-secondary ms-2" id="release-btn">
                <i class="bi bi-box-arrow-in-left me-2"></i>Release Accounts
            </button>

            <div class="progress mt-3" style="height: 8px; display: none;" id="progress-wrap">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar"></div>
            </div>
            <div id="result" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('start-btn').addEventListener('click', async () => {
    const btn = document.getElementById('start-btn');
    const bar = document.getElementById('progress-bar');
    const wrap = document.getElementById('progress-wrap');
    const resEl = document.getElementById('result');
    btn.disabled = true;
    wrap.style.display = 'block';
    bar.style.width = '10%';
    resEl.innerHTML = '';
    try {
        const currentServer = window.API_BASE || '{{ api_base|default:"http://94.141.161.231:8000" }}';
        const res = await fetch('{% url "api_tiktok_videos_start_upload" %}', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `server_url=${encodeURIComponent(currentServer)}`
        });
        const data = await res.json();
        if (res.ok) {
            bar.style.width = '100%';
            resEl.innerHTML = '<div class="alert alert-success">Upload started successfully</div>';
        } else {
            bar.style.width = '100%';
            bar.className = 'progress-bar bg-danger';
            resEl.innerHTML = `<div class=\"alert alert-danger\">${data.detail || 'Failed to start upload'}</div>`;
        }
    } catch (err) {
        bar.style.width = '100%';
        bar.className = 'progress-bar bg-danger';
        resEl.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
    } finally {
        setTimeout(() => {
            btn.disabled = false;
            wrap.style.display = 'none';
            bar.className = 'progress-bar';
            bar.style.width = '0%';
        }, 2500);
    }
});

document.getElementById('release-btn').addEventListener('click', async () => {
    // Confirmation dialog
    if (!confirm('Are you sure you want to release accounts back to the database? This will make them available for other tasks.')) {
        return;
    }
    
    const btn = document.getElementById('release-btn');
    const resEl = document.getElementById('result');
    btn.disabled = true;
    resEl.innerHTML = '';
    try {
        const currentServer = window.API_BASE || '{{ api_base|default:"http://94.141.161.231:8000" }}';
        const res = await fetch('{% url "api_tiktok_videos_release_accounts" %}', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `server_url=${encodeURIComponent(currentServer)}`
        });
        const data = await res.json();
        if (res.ok) {
            resEl.innerHTML = '<div class="alert alert-success">Release request sent</div>';
        } else {
            resEl.innerHTML = `<div class=\"alert alert-danger\">${data.detail || 'Failed to release accounts'}</div>`;
        }
    } catch (err) {
        resEl.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
    } finally {
        setTimeout(() => { btn.disabled = false; }, 1200);
    }
});

// Listen for server change events from tiktok-server-selector.js
window.addEventListener('tiktok-server-changed', function(event) {
    console.log('Server changed event received:', event.detail.serverUrl);
    // Update window.API_BASE for this page
    window.API_BASE = event.detail.serverUrl;
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Ensure API_BASE is set
    setTimeout(() => {
        if (!window.API_BASE) {
            // Fallback to default if not set
            window.API_BASE = '{{ api_base|default:"http://94.141.161.231:8000" }}';
        }
    }, 200);
});
</script>
{% endblock %}


