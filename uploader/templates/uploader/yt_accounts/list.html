{% extends "uploader/yt_base.html" %}

{% block title %}YouTube Accounts - YouTube Shorts Uploader{% endblock %}

{% block extra_css %}
<style>
	/* YouTube-inspired color scheme */
	:root {
		--yt-red: #ff0000;
		--yt-dark-red: #cc0000;
		--yt-light-gray: #f9f9f9;
		--yt-gray: #606060;
		--yt-dark-gray: #282828;
		--yt-border: #e0e0e0;
	}
	
	.table thead th { 
		white-space: nowrap; 
		font-weight: 600; 
		color: var(--yt-gray);
		border-bottom: 2px solid var(--yt-border);
	}
	.table td { 
		vertical-align: middle; 
		border-bottom: 1px solid var(--yt-border);
	}
	.table tbody tr:hover { 
		background-color: var(--yt-light-gray); 
	}
	
	/* YouTube-style badges */
	.badge-status-active { 
		background: rgba(16, 185, 129, 0.1); 
		color: #10b981; 
		border: 1px solid rgba(16, 185, 129, 0.2); 
	}
	.badge-status-blocked { 
		background: rgba(239, 68, 68, 0.1); 
		color: #ef4444; 
		border: 1px solid rgba(239, 68, 68, 0.2); 
	}
	.badge-status-limited { 
		background: rgba(245, 158, 11, 0.1); 
		color: #f59e0b; 
		border: 1px solid rgba(245, 158, 11, 0.2); 
	}
	.badge-status-inactive { 
		background: rgba(107, 114, 128, 0.1); 
		color: #6b7280; 
		border: 1px solid rgba(107, 114, 128, 0.2); 
	}
	
	/* Bulk actions bar */
	#bulkActionsBar {
		display: none;
		border-left: 4px solid var(--yt-red);
		background: linear-gradient(135deg, #fff 0%, var(--yt-light-gray) 100%);
	}
	#bulkActionsBar.show {
		display: block;
		animation: slideDown 0.3s ease;
	}
	@keyframes slideDown {
		from { opacity: 0; transform: translateY(-10px); }
		to { opacity: 1; transform: translateY(0); }
	}
	.account-checkbox:checked {
		accent-color: var(--yt-red);
	}
	tr.selected {
		background-color: rgba(255, 0, 0, 0.05) !important;
	}
	
	/* YouTube-style buttons */
	.btn-yt-primary {
		background-color: var(--yt-red);
		border-color: var(--yt-red);
		color: white;
	}
	.btn-yt-primary:hover {
		background-color: var(--yt-dark-red);
		border-color: var(--yt-dark-red);
		color: white;
	}
	.btn-yt-outline {
		border-color: var(--yt-gray);
		color: var(--yt-gray);
	}
	.btn-yt-outline:hover {
		background-color: var(--yt-gray);
		border-color: var(--yt-gray);
		color: white;
	}
	
	/* Stats cards */
	.stats-card {
		background: white;
		border: 1px solid var(--yt-border);
		border-radius: 8px;
		transition: box-shadow 0.2s ease;
	}
	.stats-card:hover {
		box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2 class="mb-4 fw-bold">
            <i class="bi bi-youtube text-danger me-2"></i>YouTube Accounts
        </h2>
    </div>
    <div class="col-md-6 text-end">
        <div class="btn-group" role="group">
            <a href="{% url 'yt_accounts_import' %}" class="btn btn-warning">
                <i class="bi bi-file-earmark-arrow-up"></i> Import
            </a>
            <a href="{% url 'yt_account_create' %}" class="btn btn-yt-primary">
                <i class="bi bi-plus-circle"></i> New Account
            </a>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card p-3 text-center">
            <h4 class="text-primary mb-1">{{ total_accounts }}</h4>
            <small class="text-muted">Total Accounts</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card p-3 text-center">
            <h4 class="text-success mb-1">{{ active_accounts }}</h4>
            <small class="text-muted">Active</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card p-3 text-center">
            <h4 class="text-danger mb-1">{{ blocked_accounts }}</h4>
            <small class="text-muted">Blocked</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card p-3 text-center">
            <h4 class="text-info mb-1">{{ accounts_with_proxy }}</h4>
            <small class="text-muted">With Proxy</small>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" class="alert alert-info mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <span><strong id="selectedCount">0</strong> accounts selected</span>
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearSelection()">
                <i class="bi bi-x-circle"></i> Clear
            </button>
            <button class="btn btn-sm btn-primary" onclick="showBulkActions()">
                <i class="bi bi-gear"></i> Actions
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
            <i class="bi bi-sliders"></i>
        </button>
    </div>
    <div class="collapse" id="filterCollapse">
        <div class="card-body">
            <form method="get" action="{% url 'yt_accounts_list' %}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" name="q" id="search" class="form-control" value="{{ search_query }}" placeholder="Search by email or channel name">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select name="status" id="status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="ACTIVE" {% if status_filter == 'ACTIVE' %}selected{% endif %}>Active</option>
                            <option value="BLOCKED" {% if status_filter == 'BLOCKED' %}selected{% endif %}>Blocked</option>
                            <option value="LIMITED" {% if status_filter == 'LIMITED' %}selected{% endif %}>Limited</option>
                            <option value="INACTIVE" {% if status_filter == 'INACTIVE' %}selected{% endif %}>Inactive</option>
                            <option value="PHONE_VERIFICATION_REQUIRED" {% if status_filter == 'PHONE_VERIFICATION_REQUIRED' %}selected{% endif %}>Phone Verification Required</option>
                            <option value="HUMAN_VERIFICATION_REQUIRED" {% if status_filter == 'HUMAN_VERIFICATION_REQUIRED' %}selected{% endif %}>Human Verification Required</option>
                            <option value="SUSPENDED" {% if status_filter == 'SUSPENDED' %}selected{% endif %}>Suspended</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="client" class="form-label">Client</label>
                        <select name="client" id="client" class="form-select">
                            <option value="">All Clients</option>
                            <option value="no_client" {% if client_filter == 'no_client' %}selected{% endif %}>Without Client</option>
                            <!-- Add client options here if needed -->
                        </select>
                    </div>
                    <div class="col-md-2 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Apply</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Accounts Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="selectAll" class="form-check-input" onchange="toggleAll(this)">
                        </th>
                        <th>Email</th>
                        <th>Channel Name</th>
                        <th>Status</th>
                        <th>Proxy</th>
                        <th>Locale</th>
                        <th>Last Used</th>
                        <th>Created</th>
                        <th width="120">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input account-checkbox" value="{{ account.id }}" onchange="updateSelection()">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope text-muted me-2"></i>
                                <div>
                                    <div class="fw-medium">{{ account.email }}</div>
                                    {% if account.recovery_email %}
                                    <small class="text-muted">{{ account.recovery_email }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if account.channel_name %}
                                <div class="fw-medium">{{ account.channel_name }}</div>
                                {% if account.channel_id %}
                                <small class="text-muted">{{ account.channel_id }}</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-status-{{ account.status|lower }}">
                                {{ account.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if account.proxy %}
                                <span class="badge bg-light text-dark">
                                    {{ account.proxy.host }}:{{ account.proxy.port }}
                                </span>
                            {% else %}
                                <span class="text-muted">No proxy</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{ account.locale }}</span>
                        </td>
                        <td>
                            {% if account.last_used %}
                                <small class="text-muted">{{ account.last_used|date:"M d, Y" }}</small>
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ account.created_at|date:"M d, Y" }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'yt_account_detail' account.id %}" class="btn btn-outline-primary" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'yt_account_edit' account.id %}" class="btn btn-outline-secondary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-warning change-proxy-btn" title="Change Proxy" data-account-id="{{ account.id }}" data-account-email="{{ account.email }}" data-current-proxy="{{ account.proxy.id|default:'' }}">
                                    <i class="bi bi-shield-lock"></i>
                                </button>
                                <a href="{% url 'yt_account_delete' account.id %}" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Are you sure?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No YouTube accounts found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'yt_accounts_bulk_action' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <select name="action" class="form-select" onchange="toggleActionFields()">
                            <option value="">Select action...</option>
                            <option value="change_status">Change Status</option>
                            <option value="assign_proxy">Assign Proxy</option>
                            <option value="change_locale">Change Locale</option>
                            <option value="delete">Delete Accounts</option>
                        </select>
                    </div>
                    
                    <div id="statusField" class="mb-3" style="display: none;">
                        <label class="form-label">New Status</label>
                        <select name="new_status" class="form-select">
                            <option value="">Select status...</option>
                            <option value="ACTIVE">Active</option>
                            <option value="BLOCKED">Blocked</option>
                            <option value="LIMITED">Limited</option>
                            <option value="INACTIVE">Inactive</option>
                            <option value="PHONE_VERIFICATION_REQUIRED">Phone Verification Required</option>
                            <option value="HUMAN_VERIFICATION_REQUIRED">Human Verification Required</option>
                            <option value="SUSPENDED">Suspended</option>
                        </select>
                    </div>
                    
                    <div id="proxyField" class="mb-3" style="display: none;">
                        <label class="form-label">New Proxy</label>
                        <select name="new_proxy" class="form-select">
                            <option value="">Select proxy...</option>
                            <!-- Proxy options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div id="localeField" class="mb-3" style="display: none;">
                        <label class="form-label">New Locale</label>
                        <select name="new_locale" class="form-select">
                            <option value="">Select locale...</option>
                            <option value="en_US">English (US)</option>
                            <option value="en_GB">English (UK)</option>
                            <option value="ru_RU">Русский</option>
                            <option value="es_ES">Español</option>
                            <option value="fr_FR">Français</option>
                            <option value="de_DE">Deutsch</option>
                            <option value="pt_BR">Português (Brasil)</option>
                            <option value="ja_JP">日本語</option>
                            <option value="ko_KR">한국어</option>
                            <option value="zh_CN">中文 (简体)</option>
                        </select>
                    </div>
                    
                    <div id="selectedAccountsInfo" class="alert alert-info">
                        <strong id="modalSelectedCount">0</strong> accounts will be affected
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Action</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedAccounts = new Set();

function toggleAll(checkbox) {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedAccounts.add(cb.value);
        } else {
            selectedAccounts.delete(cb.value);
        }
    });
    updateSelection();
}

function updateSelection() {
    selectedAccounts.clear();
    document.querySelectorAll('.account-checkbox:checked').forEach(cb => {
        selectedAccounts.add(cb.value);
    });
    
    const count = selectedAccounts.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('modalSelectedCount').textContent = count;
    
    const bulkBar = document.getElementById('bulkActionsBar');
    if (count > 0) {
        bulkBar.classList.add('show');
        // Add selected class to rows
        document.querySelectorAll('tbody tr').forEach(row => {
            const checkbox = row.querySelector('.account-checkbox');
            if (checkbox && checkbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    } else {
        bulkBar.classList.remove('show');
        document.querySelectorAll('tbody tr').forEach(row => {
            row.classList.remove('selected');
        });
    }
    
    // Update select all checkbox
    const selectAll = document.getElementById('selectAll');
    const totalCheckboxes = document.querySelectorAll('.account-checkbox').length;
    selectAll.checked = count === totalCheckboxes && totalCheckboxes > 0;
    selectAll.indeterminate = count > 0 && count < totalCheckboxes;
}

function clearSelection() {
    document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function showBulkActions() {
    if (selectedAccounts.size === 0) {
        alert('Please select at least one account');
        return;
    }
    
    // Add selected account IDs to form
    const form = document.querySelector('#bulkActionsModal form');
    form.querySelectorAll('input[name="account_ids"]').forEach(input => input.remove());
    
    selectedAccounts.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'account_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function toggleActionFields() {
    const action = document.querySelector('select[name="action"]').value;
    
    // Hide all fields
    document.getElementById('statusField').style.display = 'none';
    document.getElementById('proxyField').style.display = 'none';
    document.getElementById('localeField').style.display = 'none';
    
    // Show relevant field
    if (action === 'change_status') {
        document.getElementById('statusField').style.display = 'block';
    } else if (action === 'assign_proxy') {
        document.getElementById('proxyField').style.display = 'block';
    } else if (action === 'change_locale') {
        document.getElementById('localeField').style.display = 'block';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateSelection();
    
    // Add event listeners for change proxy buttons
    document.querySelectorAll('.change-proxy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const accountId = this.dataset.accountId;
            const accountEmail = this.dataset.accountEmail;
            const currentProxy = this.dataset.currentProxy;
            
            // Set account info in modal
            document.getElementById('changeProxyAccountEmail').textContent = accountEmail;
            document.getElementById('changeProxyAccountId').value = accountId;
            
            // Load available proxies
            loadAvailableProxies(accountId, currentProxy);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('changeProxyModal'));
            modal.show();
        });
    });
    
    // Function to load available proxies
    function loadAvailableProxies(accountId, currentProxyId) {
        const select = document.getElementById('newProxyId');
        select.innerHTML = '<option value="">-- Loading proxies... --</option>';
        
        fetch(`/yt-shorts/accounts/${accountId}/available-proxies/`)
            .then(response => response.json())
            .then(data => {
                select.innerHTML = '<option value="">-- Select Proxy --</option>';
                
                if (data.proxies && data.proxies.length > 0) {
                    data.proxies.forEach(proxy => {
                        const option = document.createElement('option');
                        option.value = proxy.id;
                        option.textContent = `${proxy.host}:${proxy.port} (${proxy.country || 'Unknown'})`;
                        if (proxy.id == currentProxyId) {
                            option.textContent += ' (Current)';
                        }
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No available proxies';
                    option.disabled = true;
                    select.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading proxies:', error);
                select.innerHTML = '<option value="">-- Error loading proxies --</option>';
            });
    }
    
    // Handle form submission
    document.getElementById('changeProxyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const accountId = document.getElementById('changeProxyAccountId').value;
        const proxyId = document.getElementById('newProxyId').value;
        
        if (!proxyId) {
            alert('Please select a proxy');
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('proxy_id', proxyId);
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Changing...';
        submitBtn.disabled = true;
        
        // Submit form
        fetch(`/yt-shorts/accounts/${accountId}/change-proxy/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload page
                bootstrap.Modal.getInstance(document.getElementById('changeProxyModal')).hide();
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error changing proxy: ' + error.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
});
</script>

<!-- Change Proxy Modal -->
<div class="modal fade" id="changeProxyModal" tabindex="-1" aria-labelledby="changeProxyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeProxyModalLabel">
                    <i class="bi bi-shield-lock"></i> Change Proxy
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="changeProxyForm">
                {% csrf_token %}
                <input type="hidden" id="changeProxyAccountId" name="account_id" value="">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-4"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading">Account</h6>
                                <p class="mb-0" id="changeProxyAccountEmail"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newProxyId" class="form-label">Select New Proxy</label>
                        <select name="proxy_id" id="newProxyId" class="form-select" required>
                            <option value="">-- Select Proxy --</option>
                            <!-- Proxies will be loaded via AJAX -->
                        </select>
                    </div>
                    
                    <div class="alert alert-warning">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading">Important</h6>
                                <p class="mb-0">This will update both the account proxy and the Dolphin profile proxy (if exists).</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-shield-lock"></i> Change Proxy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
