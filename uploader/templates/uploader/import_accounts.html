{% extends "uploader/base.html" %}

{% block title %}Import Accounts - Instagram Uploader{% endblock %}

{% block extra_css %}
<style>
	/* Limit loading modal height to avoid full-screen transparent frame */
	#loadingModal .modal-dialog { max-width: 420px; }
	#loadingModal .modal-content {
		max-height: 450px;
		overflow: hidden;
		border-radius: 12px;
	}
	#loadingModal .modal-body {
		max-height: calc(450px - 80px);
		overflow-y: auto;
	}
	/* Make only this modal use a dimmed backdrop (base disables globally) */
	body.use-backdrop .modal-backdrop {
		opacity: .15 !important;
		background-color: rgba(0,0,0,.25) !important;
		backdrop-filter: blur(2px);
		pointer-events: auto !important;
	}
	/* Prevent overlay from feeling clickable while keeping dialog interactive */
	#loadingModal.modal { pointer-events: none; }
	#loadingModal .modal-dialog { pointer-events: all; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
	<div>
		<a href="{% url 'account_list' %}" class="text-decoration-none">
			<i class="bi bi-arrow-left"></i> Back to Accounts
		</a>
		<h2 class="mb-0 mt-2">Import Instagram Accounts</h2>
	</div>
</div>

<div class="row">
	<div class="col-lg-8 mx-auto">
		<div class="card">
			<div class="card-header">
				<h5 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Upload Accounts File</h5>
			</div>
			<div class="card-body">
				<div class="alert alert-info">
					<div class="d-flex">
						<div class="me-3">
							<i class="bi bi-info-circle-fill fs-3"></i>
						</div>
						<div class="flex-grow-1">
							<h6 class="alert-heading mb-0">
								<a class="text-decoration-none text-primary fw-bold" data-bs-toggle="collapse" href="#expectedFormats" role="button" aria-expanded="false" aria-controls="expectedFormats">
									Expected Formats <i class="bi bi-chevron-down"></i>
								</a>
							</h6>
							<p class="mb-2 mt-2">
								Upload a text file with each account on a new line in one of these formats:
							</p>
							<div class="collapse mt-2" id="expectedFormats">
							
							<div class="mt-3">
								<h6 class="fw-bold">Format 1: Basic Format</h6>
								<code>username:password</code>
								<p class="small text-muted mt-1">Basic format without 2FA or email verification.</p>
							</div>
							
							<div class="mt-3">
								<h6 class="fw-bold">Format 2: 2FA Accounts</h6>
								<code>username:password:2fa_key</code>
								<p class="small text-muted mt-1">Use this format for accounts with Two-Factor Authentication.</p>
								<p class="small">Example: <code>user1:pass123:2FAKEY123</code></p>
								<p class="small text-info mt-1"><i class="bi bi-info-circle"></i> <strong>Note:</strong> Spaces in 2FA keys will be automatically removed (e.g., "SGYJ FJDY 57CT" becomes "SGJYFJDY57CT")</p>
							</div>
							
							<div class="mt-3">
								<h6 class="fw-bold">Format 3: Email Verification Accounts</h6>
								<code>username:password:email:email_password</code>
								<p class="small text-muted mt-1">Use this format for accounts that use email verification instead of 2FA.</p>
								<p class="small">Example: <code>user2:pass456:user2@email.com:emailpass789</code></p>
							</div>
							
							<div class="mt-3">
								<h6 class="fw-bold">Format 4: TFA Accounts with Email</h6>
								<code>username:password:email:email_password:tfa_secret</code>
								<p class="small text-muted mt-1">Use this format for accounts with both email verification and Two-Factor Authentication.</p>
								<p class="small">Example: <code>user3:pass789:user3@email.com:emailpass123:2FAKEY456</code></p>
								<p class="small text-info mt-1"><i class="bi bi-info-circle"></i> <strong>Note:</strong> Spaces in 2FA keys will be automatically removed</p>
							</div>
							
							<div class="alert alert-warning mt-3 mb-0 small">
								<i class="bi bi-exclamation-triangle-fill me-2"></i> Note: The `:` (colon) is used as a separator. If any of your passwords contain the colon character, please make sure to handle them properly.
							</div>
							<div class="mt-3">
								<h6 class="fw-bold">Format 5: With device + cookies</h6>
								<code>username:password||android-<device>;uuid1;uuid2;uuid3|cookie1=value1; cookie2=value2; ...</code>
								<p class="small text-muted mt-1">If cookies are provided, they will be saved to the account and imported into the created Dolphin profile (local import if supported, otherwise remote API).</p>
							</div>
							<div class="mt-3">
								<h6 class="fw-bold">Format 6: Web cookies only</h6>
								<code>username:password|cookie1=value1; cookie2=value2; ...</code>
								<p class="small text-muted mt-1">Use this for standard browser cookies (e.g., csrftoken, sessionid, ds_user_id). Device info is not required.</p>
								<p class="small text-info mt-1"><i class="bi bi-info-circle"></i> Alternatively, you can also use <code>username:password|||cookie1=value1; ...</code> to explicitly indicate no device info.</p>
							</div>
							<div class="mt-3">
								<h6 class="fw-bold">Format 7: Email + JSON cookies array</h6>
								<code>username:password:email:email_password:[{ "name": "sessionid", "value": "...", "domain": ".instagram.com" }, ...]</code>
								<p class="small text-muted mt-1">Paste a JSON array of cookie objects as the last segment. Colons inside JSON are supported; they won't break parsing.</p>
								<ul class="small text-muted mt-1 mb-0">
									<li><strong>Required cookie fields</strong>: <code>name</code>, <code>value</code>. Optional: <code>domain</code>, <code>path</code>, <code>httpOnly</code>, <code>secure</code>.</li>
									<li>Cookies are treated as <strong>web cookies</strong> and will be saved and imported into Dolphin profile (when created).</li>
								</ul>
							</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Loading Modal -->
				<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-sm">
						<div class="modal-content">
							<div class="modal-header border-0 pb-0">
								<h5 class="modal-title" id="loadingModalLabel">
									<i class="bi bi-cloud-upload text-primary"></i> Importing Accounts
								</h5>
							</div>
							<div class="modal-body text-center py-4">
								<div class="mb-3">
									<div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
										<span class="visually-hidden">Loading...</span>
									</div>
								</div>
								<h6 class="text-primary mb-3">Processing your accounts...</h6>
								<div class="progress mb-3" style="height: 6px;">
									<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="importProgress"></div>
								</div>
								<div class="text-muted small">
									<div id="currentStep">Initializing...</div>
									<div id="stepDetails" class="mt-1">Please wait while we process your accounts and create Dolphin profiles.</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<form method="post" enctype="multipart/form-data" class="mt-4" id="importForm">
					{% csrf_token %}
					
					<div class="mb-4">
						<label for="accounts_file" class="form-label">Accounts File</label>
						<input type="file" name="accounts_file" id="accounts_file" class="form-control" accept=".txt" required>
						<div class="form-text">Select a text file with Instagram accounts</div>
					</div>

					<div class="mb-4">
						<label for="client_id" class="form-label">Assign to Client (optional)</label>
						<select class="form-select" id="client_id" name="client_id">
							<option value="">— Without client —</option>
							{% for c in clients %}
								<option value="{{ c.id }}">{{ c.name }} {% if c.agency %}(Agency: {{ c.agency.name }}){% endif %}</option>
							{% endfor %}
						</select>
						<div class="form-text">Выберите клиента, к которому будут привязаны импортируемые аккаунты.</div>
					</div>

					<div class="mb-4">
						<label for="tags" class="form-label">Assign Tag (optional)</label>
						<select class="form-select" id="tags" name="tags">
							<option value="">— Without tag —</option>
							{% for tag in tags %}
								<option value="{{ tag.id }}">{{ tag.name }}</option>
							{% endfor %}
						</select>
						<div class="form-text">Выберите тег, который будет присвоен всем импортируемым аккаунтам.</div>
					</div>

					<div class="mb-4">
						<label for="profile_locale" class="form-label">Dolphin Profile Locale</label>
						<select class="form-select" id="profile_locale" name="profile_locale">
							<option value="ru_BY" selected>ru_BY (Русский интерфейс, регион BY)</option>
							<option value="en_IN">en_IN (English interface, India)</option>
							<option value="es_CL">es_CL (Español, Chile)</option>
							<option value="es_MX">es_MX (Español, México)</option>
							<option value="pt_BR">pt_BR (Português, Brasil)</option>
							<option value="el_GR">el_GR (Ελληνικά, Ελλάδα)</option>
							<option value="de_DE">de_DE (Deutsch, Deutschland)</option>
						</select>
						<div class="form-text">Локаль профиля Dolphin. Используется для Accept-Language/TZ/Гео.</div>
					</div>
					
					<div class="mb-4">
						<label for="proxy_selection" class="form-label">Proxy Selection</label>
						<select class="form-select" id="proxy_selection" name="proxy_selection">
							<option value="locale_only" selected>Привязывать прокси к выбранной локации (по стране локали)</option>
							<option value="any">Любые свободные прокси</option>
						</select>
						<div class="form-text">Выберите, подбирать ли прокси строго под локаль (страна выбранной локали) или из любых свободных при импорте.</div>
					</div>
					
					<div class="form-check mb-4">
						<input class="form-check-input" type="checkbox" value="1" id="proxy_locale_strict" name="proxy_locale_strict">
						<label class="form-check-label" for="proxy_locale_strict">
							Только страна локали (если не хватает подходящих прокси — прервать импорт)
						</label>
					</div>

					<div class="mb-4">
						<label for="profile_mode" class="form-label">Profile Mode</label>
						<select class="form-select" id="profile_mode" name="profile_mode">
							<option value="create_profiles" selected>Создавать Dolphin веб‑профили</option>
							<option value="api_only">Только через API (без профилей)</option>
						</select>
						<div class="form-text">Выберите, создавать ли браузерные профили Dolphin. Режим API‑only пропускает создание профилей и импорт cookies в них.</div>
					</div>
					
					<div class="d-grid gap-2">
						<button type="submit" class="btn btn-primary" id="submitBtn">
							<i class="bi bi-cloud-upload"></i> Import Accounts
						</button>
						<a href="{% url 'account_list' %}" class="btn btn-outline-secondary">
							<i class="bi bi-x"></i> Cancel
						</a>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	// Handle collapse toggle for Expected Formats
	const collapseElement = document.getElementById('expectedFormats');
	const toggleLink = document.querySelector('[data-bs-toggle="collapse"]');
	const chevronIcon = toggleLink.querySelector('i');
	
	collapseElement.addEventListener('show.bs.collapse', function () {
		chevronIcon.classList.remove('bi-chevron-down');
		chevronIcon.classList.add('bi-chevron-up');
	});
	
	collapseElement.addEventListener('hide.bs.collapse', function () {
		chevronIcon.classList.remove('bi-chevron-up');
		chevronIcon.classList.add('bi-chevron-down');
	});

	const form = document.getElementById('importForm');
	const submitBtn = document.getElementById('submitBtn');
	const loadingModalEl = document.getElementById('loadingModal');
	const loadingModal = new bootstrap.Modal(loadingModalEl);
	const progressBar = document.getElementById('importProgress');
	const currentStep = document.getElementById('currentStep');
	const stepDetails = document.getElementById('stepDetails');
	
	// Toggle backdrop for this modal only (base disables globally)
	loadingModalEl.addEventListener('shown.bs.modal', function(){ document.body.classList.add('use-backdrop'); });
	loadingModalEl.addEventListener('hidden.bs.modal', function(){ document.body.classList.remove('use-backdrop'); });
	
	// Simulate progress updates
	const steps = [
		{ step: 'Reading file...', details: 'Analyzing account format and structure', progress: 10 },
		{ step: 'Validating accounts...', details: 'Checking account credentials and format', progress: 25 },
		{ step: 'Assigning proxies...', details: 'Finding available proxies for each account', progress: 40 },
		{ step: 'Creating accounts...', details: 'Saving account information to database', progress: 60 },
		{ step: 'Creating Dolphin profiles...', details: 'Generating unique browser profiles with fingerprints', progress: 80 },
		{ step: 'Finalizing...', details: 'Completing import process', progress: 95 }
	];
	
	let currentStepIndex = 0;
	let progressInterval;
	
	function updateProgress() {
		if (currentStepIndex < steps.length) {
			const step = steps[currentStepIndex];
			currentStep.textContent = step.step;
			stepDetails.textContent = step.details;
			progressBar.style.width = step.progress + '%';
			progressBar.setAttribute('aria-valuenow', step.progress);
			currentStepIndex++;
		} else {
			// Keep the last step until form submission completes
			clearInterval(progressInterval);
		}
	}
	
	form.addEventListener('submit', function(e) {
		// Show loading modal
		loadingModal.show();
		
		// Start progress simulation
		currentStepIndex = 0;
		updateProgress();
		progressInterval = setInterval(updateProgress, 2000); // Update every 2 seconds
		
		// Disable submit button
		submitBtn.disabled = true;
		submitBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Importing...';
		
		// Form will submit normally, modal will stay open until redirect
	});
	
	// Handle modal close (if user tries to close it)
	loadingModalEl.addEventListener('hidden.bs.modal', function () {
		clearInterval(progressInterval);
		submitBtn.disabled = false;
		submitBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Import Accounts';
	});
});
</script>
{% endblock %}