{% extends "uploader/base.html" %}
{% load static %}

{% block title %}{{ task.name }} - YouTube Shorts Bulk Upload{% endblock %}

{% block extra_css %}
<style>
    /* YouTube Red Theme */
    .card.border-danger {
        border-color: #ff0000 !important;
    }
    .text-danger {
        color: #ff0000 !important;
    }
    .btn-danger {
        background: linear-gradient(135deg, #ff0000, #cc0000);
        border: none;
    }
    .btn-danger:hover {
        background: linear-gradient(135deg, #cc0000, #990000);
    }
    .bg-danger {
        background: linear-gradient(135deg, #ff0000, #cc0000) !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Task Header -->
<div class="card mb-4 shadow-sm border-danger" style="border-top: 4px solid #dc3545;">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-3">
                    <i class="bi bi-youtube text-danger me-2"></i>
                    {{ task.name }}
                </h2>
                <div class="d-flex gap-3 flex-wrap">
                    <span class="badge bg-{{ task.status|lower }} text-white px-3 py-2">
                        {{ task.get_status_display }}
                    </span>
                    <span class="text-muted">
                        <i class="bi bi-calendar3"></i> Created {{ task.created_at|date:"M d, Y H:i" }}
                    </span>
                </div>
                
                {% if task.status == 'RUNNING' or task.status == 'PARTIALLY_COMPLETED' %}
                <div class="mt-3">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ task.get_completion_percentage }}%"
                             aria-valuenow="{{ task.get_completion_percentage }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            {{ task.get_completed_count }} of {{ task.get_total_count }} accounts ({{ task.get_completion_percentage }}%)
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'yt_shorts_bulk_upload_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Accounts</h5>
                <p class="display-4 text-danger mb-0">{{ accounts|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Videos</h5>
                <p class="display-4 text-info mb-0">{{ task.videos.count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Uploaded</h5>
                <p class="display-4 text-success mb-0">{{ task.uploaded_success_total }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Failed</h5>
                <p class="display-4 text-danger mb-0">{{ task.uploaded_failed_total }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Action Panel -->
{% if task.status == 'PENDING' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="bi bi-gear me-2"></i>Task Actions
        </h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 flex-wrap">
            {% if task.videos.count == 0 %}
            <a href="{% url 'yt_shorts_add_bulk_videos' task_id=task.id %}" class="btn btn-warning">
                <i class="bi bi-camera-video me-2"></i>Add Videos First
            </a>
            {% elif accounts|length == 0 %}
            <a href="{% url 'create_yt_shorts_bulk_upload' %}" class="btn btn-warning">
                <i class="bi bi-people me-2"></i>Add Accounts First
            </a>
            {% else %}
            <a href="{% url 'start_yt_shorts_bulk_upload' task_id=task.id %}" class="btn btn-success btn-lg">
                <i class="bi bi-play-circle me-2"></i>Start Upload
            </a>
            <a href="{% url 'yt_shorts_add_bulk_videos' task_id=task.id %}" class="btn btn-outline-primary">
                <i class="bi bi-plus-circle me-2"></i>Add More Videos
            </a>
            <a href="{% url 'yt_shorts_add_bulk_titles' task_id=task.id %}" class="btn btn-outline-info">
                <i class="bi bi-file-text me-2"></i>{{ titles|length|yesno:"Update,Add" }} Titles
            </a>
            <a href="{% url 'bulk_edit_yt_shorts_videos' task_id=task.id %}" class="btn btn-outline-warning">
                <i class="bi bi-pencil me-2"></i>Bulk Edit Settings
            </a>
            {% endif %}
            
            <a href="{% url 'delete_yt_shorts_bulk_upload' task_id=task.id %}" 
               class="btn btn-outline-danger"
               onclick="return confirm('Are you sure you want to delete this task?')">
                <i class="bi bi-trash3 me-2"></i>Delete Task
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Tables -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>
                    Selected Accounts ({{ accounts|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                {% if accounts %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Account</th>
                                <th>Videos</th>
                                <th>Success</th>
                                <th>Failed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account_task in accounts %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ account_task.account.email }}</strong>
                                        {% if account_task.account.channel_name %}
                                        <div class="text-muted small">{{ account_task.account.channel_name }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td><span class="badge bg-secondary">{{ task.videos.count }}</span></td>
                                <td><span class="badge bg-success">{{ account_task.uploaded_success_count }}</span></td>
                                <td><span class="badge bg-danger">{{ account_task.uploaded_failed_count }}</span></td>
                                <td><span class="badge bg-{{ account_task.status|lower }}">{{ account_task.get_status_display }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No accounts selected</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-camera-video me-2"></i>
                    Videos ({{ task.videos.count }})
                </h5>
            </div>
            <div class="card-body p-0">
                {% if task.videos %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Filename</th>
                                <th>Assigned To</th>
                                <th>Title</th>
                                <th>Visibility</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for video in task.videos.all %}
                            <tr>
                                <td>
                                    <code class="small">{{ video.video_file.name|slice:"20:" }}</code>
                                </td>
                                <td>
                                    {% if video.assigned_to %}
                                    <span class="badge bg-primary">{{ video.assigned_to.account.email|truncatechars:20 }}</span>
                                    {% else %}
                                    <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if video.title_data %}
                                    <span title="{{ video.title_data.title }}">
                                        {{ video.title_data.title|truncatechars:20 }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">No title</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ video.get_effective_visibility }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-camera-video text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No videos added</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Logs Section -->
{% if task.status != 'PENDING' %}
<div class="card shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="bi bi-terminal me-2"></i>
            Execution Logs
        </h5>
    </div>
    <div class="card-body">
        <pre class="bg-dark text-light p-3 rounded" style="max-height: 600px; overflow-y: auto;">{{ task.log|default:"No logs available yet..." }}</pre>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Progress update function
    function updateTaskProgress() {
        fetch('{% url "yt_shorts_bulk_task_logs" task_id=task.id %}')
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                if (data.completion_percentage !== undefined) {
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    if (progressBar) {
                        progressBar.style.width = data.completion_percentage + '%';
                    }
                    
                    if (progressText && data.completed_count !== undefined && data.total_count !== undefined) {
                        progressText.textContent = `${data.completed_count} of ${data.total_count} accounts completed (${data.completion_percentage}%)`;
                    }
                }
                
                // Update status badge
                if (data.status) {
                    const statusBadge = document.querySelector('.badge');
                    if (statusBadge) {
                        // Remove all status classes
                        statusBadge.classList.remove('bg-pending', 'bg-running', 'bg-completed', 'bg-failed', 'bg-partial');
                        
                        // Add appropriate class and update content
                        statusBadge.classList.add('bg-' + data.status.toLowerCase());
                        statusBadge.textContent = data.status_display || data.status;
                    }
                }
                
                // Update logs
                if (data.logs) {
                    const logContainer = document.querySelector('pre');
                    if (logContainer) {
                        logContainer.textContent = data.logs;
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
            })
            .catch(() => {});
    }
    
    // Periodic progress updates every 3 seconds
    setInterval(updateTaskProgress, 3000);
    
    // Initial update
    updateTaskProgress();
});
</script>
{% endblock %}

