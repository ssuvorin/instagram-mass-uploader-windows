{% extends "uploader/base.html" %}
{% load static %}

{% block title %}{{ task.name }} - YouTube Shorts Bulk Upload{% endblock %}

{% block extra_css %}
<style>
    /* YouTube Red Theme */
    .card.border-danger {
        border-color: #ff0000 !important;
    }
    .text-danger {
        color: #ff0000 !important;
    }
    .btn-danger {
        background: linear-gradient(135deg, #ff0000, #cc0000);
        border: none;
    }
    .btn-danger:hover {
        background: linear-gradient(135deg, #cc0000, #990000);
    }
    .bg-danger {
        background: linear-gradient(135deg, #ff0000, #cc0000) !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Task Header -->
<div class="card mb-4 shadow-sm border-danger" style="border-top: 4px solid #dc3545;">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-3">
                    <i class="bi bi-youtube text-danger me-2"></i>
                    {{ task.name }}
                </h2>
                <div class="d-flex gap-3 flex-wrap">
                    <span class="badge bg-{{ task.status|lower }} text-white px-3 py-2">
                        {{ task.get_status_display }}
                    </span>
                    <span class="text-muted">
                        <i class="bi bi-calendar3"></i> Created {{ task.created_at|date:"M d, Y H:i" }}
                    </span>
                </div>
                
                {% if task.status == 'RUNNING' or task.status == 'PARTIALLY_COMPLETED' %}
                <div class="mt-3">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             id="progress-bar"
                             aria-valuenow="{{ task.get_completion_percentage|default:0 }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            <span id="progress-text">{{ task.get_completed_count|default:0 }} of {{ task.get_total_count|default:0 }} accounts ({{ task.get_completion_percentage|default:0 }}%)</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'yt_shorts_bulk_upload_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Accounts</h5>
                <p class="display-4 text-danger mb-0">{{ accounts|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Videos</h5>
                <p class="display-4 text-info mb-0">{{ task.videos.count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Uploaded</h5>
                <p class="display-4 text-success mb-0">{{ task.uploaded_success_total }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-muted">Failed</h5>
                <p class="display-4 text-danger mb-0">{{ task.uploaded_failed_total }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Action Panel -->
{% if task.status == 'PENDING' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="bi bi-gear me-2"></i>Task Actions
        </h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 flex-wrap">
            {% if task.videos.count == 0 %}
            <a href="{% url 'yt_shorts_add_bulk_videos' task_id=task.id %}" class="btn btn-warning">
                <i class="bi bi-camera-video me-2"></i>Add Videos First
            </a>
            {% elif accounts|length == 0 %}
            <a href="{% url 'create_yt_shorts_bulk_upload' %}" class="btn btn-warning">
                <i class="bi bi-people me-2"></i>Add Accounts First
            </a>
            {% else %}
            <a href="{% url 'start_yt_shorts_bulk_upload' task_id=task.id %}" class="btn btn-success btn-lg" id="startUploadBtn">
                <i class="bi bi-play-circle me-2"></i>Start Upload
            </a>
            <a href="{% url 'yt_shorts_add_bulk_videos' task_id=task.id %}" class="btn btn-outline-primary" id="addVideosBtn">
                <i class="bi bi-plus-circle me-2"></i>Add More Videos
            </a>
            <a href="{% url 'yt_shorts_add_bulk_titles' task_id=task.id %}" class="btn btn-outline-info" id="addTitlesBtn">
                <i class="bi bi-file-text me-2"></i>{{ titles|length|yesno:"Update,Add" }} Titles
            </a>
            <a href="{% url 'bulk_edit_yt_shorts_videos' task_id=task.id %}" class="btn btn-outline-warning" id="editSettingsBtn">
                <i class="bi bi-pencil me-2"></i>Bulk Edit Settings
            </a>
            {% endif %}
            
            <a href="{% url 'delete_yt_shorts_bulk_upload' task_id=task.id %}" 
               class="btn btn-outline-danger"
               onclick="return confirm('Are you sure you want to delete this task?')">
                <i class="bi bi-trash3 me-2"></i>Delete Task
            </a>
        </div>
    </div>
</div>
{% elif task.status == 'RUNNING' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
            <i class="bi bi-hourglass-split me-2"></i>Task Running
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Upload in progress!</strong> Please wait for the process to complete. You can monitor the progress in the logs below.
        </div>
    </div>
</div>
{% elif task.status == 'COMPLETED' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">
            <i class="bi bi-check-circle me-2"></i>Task Completed
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-success mb-0">
            <i class="bi bi-check-circle me-2"></i>
            <strong>Upload completed!</strong> Check the results below for detailed information.
        </div>
    </div>
</div>
{% elif task.status == 'FAILED' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>Task Failed
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-danger mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Upload failed!</strong> Check the logs below for error details.
        </div>
    </div>
</div>
{% endif %}

<!-- Data Tables -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>
                    Selected Accounts ({{ accounts|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                {% if accounts %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Account</th>
                                <th>Videos</th>
                                <th>Success</th>
                                <th>Failed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account_task in accounts %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ account_task.account.email }}</strong>
                                        {% if account_task.account.channel_name %}
                                        <div class="text-muted small">{{ account_task.account.channel_name }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td><span class="badge bg-secondary">{{ task.videos.count }}</span></td>
                                <td><span class="badge bg-success">{{ account_task.uploaded_success_count }}</span></td>
                                <td><span class="badge bg-danger">{{ account_task.uploaded_failed_count }}</span></td>
                                <td><span class="badge bg-{{ account_task.status|lower }}">{{ account_task.get_status_display }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No accounts selected</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-camera-video me-2"></i>
                    Videos ({{ task.videos.count }})
                </h5>
            </div>
            <div class="card-body p-0">
                {% if task.videos %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Filename</th>
                                <th>Assigned To</th>
                                <th>Title</th>
                                <th>Visibility</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for video in task.videos.all %}
                            <tr>
                                <td>
                                    <code class="small">{{ video.video_file.name|slice:"20:" }}</code>
                                </td>
                                <td>
                                    {% if video.assigned_to %}
                                    <span class="badge bg-primary">{{ video.assigned_to.account.email|truncatechars:20 }}</span>
                                    {% else %}
                                    <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if video.title_data %}
                                    <span title="{{ video.title_data.title }}">
                                        {{ video.title_data.title|truncatechars:20 }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">No title</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ video.get_effective_visibility }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-camera-video text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No videos added</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Logs Section -->
<div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-terminal me-2"></i>
            Execution Logs
        </h5>
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary" id="toggle-logs-refresh">
                <i class="bi bi-arrow-clockwise"></i> Auto-refresh
            </button>
            <button type="button" class="btn btn-outline-secondary" id="scroll-logs-bottom">
                <i class="bi bi-arrow-down"></i> Bottom
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="log-container" id="logs-container" style="background: #1a1a1a; color: #ffffff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.4; max-height: 600px; overflow-y: auto; padding: 20px; border-radius: 8px; border: 1px solid #333;">
            <div class="text-center text-muted py-4">
                <i class="bi bi-hourglass-split"></i>
                Loading logs...
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize progress bar width without injecting template variables into JS
    const progressBar = document.getElementById('progress-bar');
    if (progressBar) {
        const valNowAttr = progressBar.getAttribute('aria-valuenow');
        const percentage = parseInt(valNowAttr || '0', 10);
        progressBar.style.width = percentage + '%';
    }
    
    // Progress update function
    function updateTaskProgress() {
        fetch('{% url "yt_shorts_bulk_task_logs" task_id=task.id %}')
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                if (data.completion_percentage !== undefined) {
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    
                    if (progressBar) {
                        progressBar.style.width = data.completion_percentage + '%';
                    }
                    
                    if (progressText && data.completed_count !== undefined && data.total_count !== undefined) {
                        progressText.textContent = `${data.completed_count} of ${data.total_count} accounts completed (${data.completion_percentage}%)`;
                    }
                }
                
                // Update status badge
                if (data.status) {
                    const statusBadge = document.querySelector('.badge');
                    if (statusBadge) {
                        // Remove all status classes
                        statusBadge.classList.remove('bg-pending', 'bg-running', 'bg-completed', 'bg-failed', 'bg-partial');
                        
                        // Add appropriate class and update content
                        statusBadge.classList.add('bg-' + data.status.toLowerCase());
                        statusBadge.textContent = data.status_display || data.status;
                    }
                }
                
                // Update logs
                if (data.log) {
                    displayLogs(data.log);
                }
            })
            .catch(() => {});
    }
    
    // Logs functionality
    let logsAutoRefresh = true;
    let logsRefreshInterval;
    
    function displayLogs(logText) {
        const logsContainer = document.getElementById('logs-container');
        if (!logsContainer) return;
        
        if (!logText || logText.trim() === '') {
            logsContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-info-circle"></i> No logs available yet</div>';
            return;
        }
        
        const lines = logText.split('\n').filter(line => line.trim() !== '');
        let html = '';
        
        lines.forEach(line => {
            const logEntry = parseLogLine(line);
            html += logEntry;
        });
        
        logsContainer.innerHTML = html;
        scrollLogsToBottom();
    }
    
    function parseLogLine(line) {
        let level = 'info';
        let message = line;
        
        // Extract log level
        if (line.includes('[ERROR]') || line.includes('[FAIL]')) {
            level = 'error';
        } else if (line.includes('[SUCCESS]') || line.includes('[OK]')) {
            level = 'success';
        } else if (line.includes('[WARNING]') || line.includes('[WARN]')) {
            level = 'warning';
        }
        
        // Extract timestamp
        const timestampMatch = line.match(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/);
        let timestamp = '';
        if (timestampMatch) {
            timestamp = `<span style="color: #888; font-size: 11px;">${timestampMatch[1]}</span> `;
        }
        
        // Clean up message
        message = line.replace(/\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\]/, '').trim();
        
        // Color coding
        let colorClass = '';
        let bgClass = '';
        switch(level) {
            case 'error':
                colorClass = 'color: #f44336;';
                bgClass = 'background: rgba(244, 67, 54, 0.1);';
                break;
            case 'success':
                colorClass = 'color: #4caf50;';
                bgClass = 'background: rgba(76, 175, 80, 0.1);';
                break;
            case 'warning':
                colorClass = 'color: #ff9800;';
                bgClass = 'background: rgba(255, 152, 0, 0.1);';
                break;
            default:
                colorClass = 'color: #4fc3f7;';
        }
        
        return `<div style="margin-bottom: 8px; padding: 4px 8px; border-radius: 4px; ${bgClass} ${colorClass}">${timestamp}${escapeHtml(message)}</div>`;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function scrollLogsToBottom() {
        const logsContainer = document.getElementById('logs-container');
        if (logsContainer) {
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    }
    
    function startLogsRefresh() {
        logsRefreshInterval = setInterval(() => {
            if (logsAutoRefresh) {
                updateTaskProgress();
            }
        }, 2000); // Refresh every 2 seconds
    }
    
    function stopLogsRefresh() {
        if (logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
        }
    }
    
    // Toggle logs auto-refresh
    const toggleLogsRefreshBtn = document.getElementById('toggle-logs-refresh');
    if (toggleLogsRefreshBtn) {
        toggleLogsRefreshBtn.addEventListener('click', function() {
            logsAutoRefresh = !logsAutoRefresh;
            
            if (logsAutoRefresh) {
                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Auto-refresh';
                this.classList.remove('btn-outline-warning');
                this.classList.add('btn-outline-secondary');
                startLogsRefresh();
            } else {
                this.innerHTML = '<i class="bi bi-pause-circle"></i> Paused';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-outline-warning');
                stopLogsRefresh();
            }
        });
    }
    
    // Scroll to bottom button
    const scrollLogsBottomBtn = document.getElementById('scroll-logs-bottom');
    if (scrollLogsBottomBtn) {
        scrollLogsBottomBtn.addEventListener('click', scrollLogsToBottom);
    }
    
    // Start logs refresh
    startLogsRefresh();
    
    // Periodic progress updates every 3 seconds
    setInterval(updateTaskProgress, 3000);
    
    // Initial update
    updateTaskProgress();
    
    // Hide entire Task Actions card after Start Upload click to prevent further changes
    const startUploadBtn = document.getElementById('startUploadBtn');
    if (startUploadBtn) {
        startUploadBtn.addEventListener('click', function() {
            try {
                // Hide the whole Task Actions card immediately
                const card = this.closest('.card');
                if (card) {
                    card.style.display = 'none';
                }
            } catch (e) {
                // Fallback: hide individual buttons
                this.style.display = 'none';
                const addVideosBtn = document.getElementById('addVideosBtn');
                const addTitlesBtn = document.getElementById('addTitlesBtn');
                const editSettingsBtn = document.getElementById('editSettingsBtn');
                if (addVideosBtn) addVideosBtn.style.display = 'none';
                if (addTitlesBtn) addTitlesBtn.style.display = 'none';
                if (editSettingsBtn) editSettingsBtn.style.display = 'none';
            }
        }, { once: true });
    }
});
</script>
{% endblock %}

