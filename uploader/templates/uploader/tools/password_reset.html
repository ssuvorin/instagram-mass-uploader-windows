{% extends "uploader/base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="fw-bold mb-4">
            <i class="bi bi-key me-2"></i>Password Reset Tool
        </h2>

        {% if not instagrapi_available %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Error:</strong> instagrapi library is not available. Password reset functionality is disabled.
        </div>
        {% endif %}

        <div class="card">
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Username Input -->
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="bi bi-person me-1"></i>Instagram Username
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">@</span>
                            <input type="text" 
                                   class="form-control" 
                                   id="username" 
                                   name="username" 
                                   placeholder="Enter Instagram username"
                                   required
                                   {% if not instagrapi_available %}disabled{% endif %}>
                            <div class="invalid-feedback">
                                Please provide a valid Instagram username.
                            </div>
                        </div>
                        <div class="form-text">
                            Enter the Instagram username for which you want to reset the password.
                        </div>
                    </div>

                    <!-- Quick Select from Accounts -->
                    {% if accounts %}
                    <div class="mb-3">
                        <label for="account_select" class="form-label">
                            <i class="bi bi-list me-1"></i>Or Select from Existing Accounts
                        </label>
                        <select class="form-select" id="account_select">
                            <option value="">Choose an account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.username }}" data-proxy="{% if account.proxy %}{{ account.proxy.id }}{% elif account.current_proxy %}{{ account.current_proxy.id }}{% endif %}">
                                {{ account.username }} {% if account.proxy or account.current_proxy %}<small class="text-muted">(has proxy)</small>{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- Proxy Configuration -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-shield me-1"></i>Proxy Configuration
                        </label>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="proxy_option" id="no_proxy" value="none" checked>
                            <label class="form-check-label" for="no_proxy">
                                No proxy (direct connection)
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="proxy_option" id="account_proxy" value="account">
                            <label class="form-check-label" for="account_proxy">
                                Use account's assigned proxy
                            </label>
                        </div>
                        
                        {% if proxies %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="proxy_option" id="custom_proxy" value="custom">
                            <label class="form-check-label" for="custom_proxy">
                                Use custom proxy
                            </label>
                        </div>
                        
                        <div class="mt-2" id="custom_proxy_select" style="display: none;">
                            <select class="form-select" name="proxy_id">
                                <option value="">Select a proxy...</option>
                                {% for proxy in proxies %}
                                <option value="{{ proxy.id }}">
                                    {{ proxy.host }}:{{ proxy.port }} ({{ proxy.type|upper }})
                                    {% if proxy.user %} - {{ proxy.user }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" 
                                class="btn btn-primary btn-lg"
                                {% if not instagrapi_available %}disabled{% endif %}>
                            <i class="bi bi-key me-2"></i>Reset Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Additional Tools -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-collection text-primary mb-2" style="font-size: 2rem;"></i>
                        <h5 class="card-title">Bulk Password Reset</h5>
                        <p class="card-text">Reset passwords for multiple accounts at once.</p>
                        <a href="{% url 'bulk_password_reset' %}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-right me-1"></i>Bulk Reset
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-info-circle text-info mb-2" style="font-size: 2rem;"></i>
                        <h5 class="card-title">How it Works</h5>
                        <p class="card-text">Learn about the password reset process and requirements.</p>
                        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bi bi-question-circle me-1"></i>Learn More
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Display -->
        {% if logs %}
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-journal-text me-2"></i>Operation Logs
            </div>
            <div class="card-body">
                <div class="logs-container" style="max-height: 300px; overflow-y: auto;">
                    {% for log in logs %}
                    <div class="log-entry">
                        <code>{{ log }}</code>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">
                    <i class="bi bi-info-circle me-2"></i>Password Reset Help
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6><i class="bi bi-gear me-2"></i>How Password Reset Works</h6>
                <p>This tool uses Instagram's official password reset mechanism via the instagrapi library:</p>
                <ol>
                    <li>The tool sends a password reset request to Instagram for the specified username</li>
                    <li>Instagram sends a password reset email to the account's registered email address</li>
                    <li>You need to check the email and follow Instagram's instructions to complete the reset</li>
                </ol>

                <h6 class="mt-3"><i class="bi bi-shield me-2"></i>Proxy Usage</h6>
                <ul>
                    <li><strong>No proxy:</strong> Direct connection to Instagram (fastest but may be rate limited)</li>
                    <li><strong>Account proxy:</strong> Uses the proxy assigned to the selected account (recommended)</li>
                    <li><strong>Custom proxy:</strong> Uses a specific proxy from your proxy list</li>
                </ul>

                <h6 class="mt-3"><i class="bi bi-exclamation-triangle me-2"></i>Important Notes</h6>
                <div class="alert alert-warning">
                    <ul class="mb-0">
                        <li>You must have access to the email associated with the Instagram account</li>
                        <li>Instagram may rate limit password reset requests</li>
                        <li>This tool only initiates the reset - you must complete it through email</li>
                        <li>Some accounts may be protected and not allow password resets</li>
                    </ul>
                </div>

                <h6 class="mt-3"><i class="bi bi-bug me-2"></i>Troubleshooting</h6>
                <ul>
                    <li><strong>Username not found:</strong> Verify the username is correct and the account exists</li>
                    <li><strong>Rate limited:</strong> Wait a few minutes before trying again</li>
                    <li><strong>Proxy errors:</strong> Try using a different proxy or no proxy</li>
                    <li><strong>No email received:</strong> Check spam folder or try again later</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Account selection functionality
    const accountSelect = document.getElementById('account_select');
    const usernameInput = document.getElementById('username');
    const accountProxyRadio = document.getElementById('account_proxy');
    
    if (accountSelect) {
        accountSelect.addEventListener('change', function() {
            if (this.value) {
                usernameInput.value = this.value;
                
                // Auto-select account proxy if available
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.dataset.proxy) {
                    accountProxyRadio.checked = true;
                }
            }
        });
    }
    
    // Proxy option handling
    const proxyOptions = document.querySelectorAll('input[name="proxy_option"]');
    const customProxySelect = document.getElementById('custom_proxy_select');
    
    proxyOptions.forEach(radio => {
        radio.addEventListener('change', function() {
            if (customProxySelect) {
                customProxySelect.style.display = this.value === 'custom' ? 'block' : 'none';
            }
        });
    });
    
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.log-entry {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
    padding: 0.25rem;
    background-color: rgba(0,0,0,0.02);
    border-radius: 3px;
}

.dark-theme .log-entry {
    background-color: rgba(255,255,255,0.05);
}

.logs-container {
    font-size: 0.9rem;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}