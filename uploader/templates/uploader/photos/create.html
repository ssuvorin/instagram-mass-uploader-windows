{% extends 'uploader/base.html' %}

{% block title %}Create Photo Post - Instagram Uploader{% endblock %}

{% block extra_css %}
<style>
  .accounts-controls { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.25rem; border-radius: 12px 12px 0 0; border-bottom: none; }
  .accounts-controls .form-control { border-radius: 25px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; padding-left: 2.5rem; }
  .accounts-controls .form-control::placeholder { color: rgba(255,255,255,0.7); }
  .accounts-controls .form-control:focus { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.6); box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25); color: white; }
  .client-filter-wrapper { position: relative; }
  .client-filter-wrapper select { border-radius: 25px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; padding: 0.5rem 1rem; width: 100%; }
  .client-filter-wrapper select:focus { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.6); box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25); color: white; }
  .client-filter-wrapper select option { background: #667eea; color: white; }
  .search-wrapper { position: relative; }
  .bulk-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
  .bulk-action-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; user-select: none; display: flex; align-items: center; gap: 0.25rem; }
  .bulk-action-btn:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.5); }
  .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.7); }

  /* Pagination */
  .pagination-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: white;
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 12px 12px;
    font-size: 0.875rem;
    color: #718096;
  }

  .page-size-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .page-size-selector select {
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
  }
  .accounts-controls .form-control { border-radius: 25px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; padding-left: 2.5rem; }
  .accounts-grid { padding: 1rem; max-height: 600px; overflow-y: auto; background: #f8f9fb; border-radius: 0 0 12px 12px; position: relative; }
  .account-item { margin-bottom: 0.75rem; }
  .account-card { border: 2px solid #e9ecef; border-radius: 12px; background: white; padding: 1rem; position: relative; display: flex; gap: 12px; align-items: center; cursor: pointer; }
  .account-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); }
  .account-checkbox { position: absolute; opacity: 0; pointer-events: none; }
  .custom-checkbox { width: 22px; height: 22px; border: 2px solid #dee2e6; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: white; flex-shrink: 0; }
  .custom-checkbox i { color: white; font-size: 14px; opacity: 0; }
  .account-checkbox:checked ~ .account-card .custom-checkbox { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; }
  .account-checkbox:checked ~ .account-card .custom-checkbox i { opacity: 1; }
  .account-username { font-weight: 600; color: #2d3748; }
  .account-stats { color: #718096; font-size: 0.875rem; }
  .account-badges { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .badge-custom { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.72rem; font-weight: 500; border: 1px solid; }
  .badge-proxy-ok { background: rgba(34, 197, 94, 0.1); color: #059669; border-color: rgba(34, 197, 94, 0.3); }
  .badge-proxy-bad { background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(239, 68, 68, 0.3); }
  .summary-bar { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
  .view-toggle { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; padding: 0.25rem; display: inline-flex; gap: 4px; }
  .view-toggle-btn { background: transparent; border: none; color: #fff; padding: 0.3rem 0.7rem; border-radius: 15px; cursor: pointer; }
  .view-toggle-btn.active { background: white; color: #667eea; }
  .compact-mode .account-card { padding: 0.6rem; border-radius: 8px; border-width: 1px; }
  .compact-mode .custom-checkbox { width: 20px; height: 20px; border-width: 1px; border-radius: 4px; }
  .compact-mode .badge-custom { padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.65rem; }
  .list-mode .account-item { margin-bottom: 0.25rem; }
  .list-mode .account-card { padding: 0.75rem 1rem; border-radius: 6px; border-width: 1px; }
  
  /* Photo upload styles */
  .photo-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    background: #f8f9fb;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .photo-upload-area:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }
  .photo-upload-area.dragover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    transform: scale(1.02);
  }
  .photo-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  .photo-preview-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    border: 2px solid #e9ecef;
  }
  .photo-preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }
  .photo-preview-item .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
  }
  .photo-preview-item .filename {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    font-size: 11px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="fw-bold mb-4"><i class="bi bi-image me-2"></i>Create Photo Post</h2>

<form method="post" enctype="multipart/form-data" onsubmit="return validateAccountSelection()">
  {% csrf_token %}

  {% if form.non_field_errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">
      {% for err in form.non_field_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="summary-bar" id="accountsSummary">
    <div class="d-flex align-items-center gap-3">
      <div>
        <div class="fw-bold" id="selectedCount">0</div>
        <div class="text-muted small" id="totalCount">of {{ form.selected_accounts.field.queryset.count }} accounts selected</div>
      </div>
      <div class="d-flex gap-3 text-muted small" id="summaryStats">
        <div><i class="bi bi-check-circle text-success"></i> <span id="activeCount">{{ form.selected_accounts.field.queryset|length }}</span> active</div>
        <div><i class="bi bi-shield-check"></i> <span id="proxyCount">0</span> with proxy</div>
        <div><i class="bi bi-exclamation-triangle text-warning"></i> <span id="problemsCount">0</span> issues</div>
      </div>
    </div>
    <div style="min-width:240px">
      <div class="search-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" id="accountSearch" class="form-control" placeholder="Search accounts by username...">
      </div>
    </div>
  </div>

  <div class="card mb-3 border-0 shadow-sm" id="accountsWidget">
    <div class="accounts-controls">
      <div class="row align-items-center mb-2">
        <div class="col-md-3">
          <div class="search-wrapper">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="accountSearch" class="form-control" placeholder="Search accounts by username...">
          </div>
        </div>
        <div class="col-md-2">
          {% if form.client_filter.field.choices %}
          <div class="client-filter-wrapper">
            {{ form.client_filter }}
          </div>
          {% endif %}
        </div>
        <div class="col-md-2">
          {% if form.tag_filter.field.choices %}
          <div class="client-filter-wrapper">
            {{ form.tag_filter }}
          </div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <div class="bulk-actions">
            <div class="bulk-action-btn" id="selectAll">
              <i class="bi bi-check-all"></i> Select All
            </div>
            <div class="bulk-action-btn" id="selectNone">
              <i class="bi bi-x"></i> Clear
            </div>
            <div class="bulk-action-btn" id="selectRandom">
              <i class="bi bi-shuffle"></i> Random 10
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="d-flex justify-content-end">
            <div class="view-toggle">
              <button type="button" class="view-toggle-btn active" data-view="card"><i class="bi bi-grid-3x3-gap"></i> Cards</button>
              <button type="button" class="view-toggle-btn" data-view="compact"><i class="bi bi-list"></i> Compact</button>
              <button type="button" class="view-toggle-btn" data-view="list"><i class="bi bi-list-ul"></i> List</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="pagination-info" id="paginationInfo" style="border-radius: 0; border-top: none; margin: 0;">
            <div class="page-size-selector">
              <label>Show:</label>
              <select id="pageSize">
                <option value="20">20</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="all">All</option>
              </select>
            </div>
            <span id="paginationText">Showing 1-50 of {{ form.selected_accounts.field.queryset.count }} accounts</span>
            <div id="paginationControls" style="display: none;">
              <button type="button" class="btn btn-sm btn-outline-secondary" id="prevPage" disabled>
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <span class="mx-2" id="pageInfo">Page 1 of 1</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="nextPage" disabled>
                Next <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end">
            <div class="summary-bar" id="accountsSummary" style="margin: 0; border-radius: 0;">
              <div class="d-flex align-items-center gap-3">
                <div>
                  <div class="fw-bold" id="selectedCount">0</div>
                  <div class="text-muted small" id="totalCount">of {{ form.selected_accounts.field.queryset.count }} accounts selected</div>
                </div>
                <div class="d-flex gap-3 text-muted small" id="summaryStats">
                  <div><i class="bi bi-check-circle text-success"></i> <span id="activeCount">{{ form.selected_accounts.field.queryset|length }}</span> active</div>
                  <div><i class="bi bi-shield-check"></i> <span id="proxyCount">0</span> with proxy</div>
                  <div><i class="bi bi-exclamation-triangle text-warning"></i> <span id="problemsCount">0</span> issues</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="accounts-grid">
      <div class="row" id="accountsContainer">
        {% for account in form.selected_accounts.field.queryset %}
        <div class="col-lg-6 col-md-12 account-item"
             data-username="{{ account.username|lower }}"
             data-has-proxy="{{ account.proxy|yesno:'true,false' }}"
             data-proxy-active="{% if account.proxy %}{{ account.proxy.is_active|yesno:'true,false' }}{% else %}false{% endif %}"
             data-status="{{ account.status|lower }}"
             data-client-id="{% if account.client %}{{ account.client.id }}{% endif %}"
             data-tag-id="{% if account.tag %}{{ account.tag.id }}{% endif %}">
          <input class="account-checkbox" type="checkbox" name="selected_accounts" value="{{ account.id }}" id="account_{{ account.id }}">
          <label class="account-card" for="account_{{ account.id }}">
            <div class="custom-checkbox"><i class="bi bi-check"></i></div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <div class="account-username">{{ account.username }}</div>
                <div class="account-stats">
                  {% if account.status == 'ACTIVE' %}
                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                    <span class="text-success">Active</span>
                  {% elif account.status == 'BLOCKED' %}
                    <i class="bi bi-x-circle-fill text-danger me-1"></i>
                    <span class="text-danger">Blocked</span>
                  {% elif account.status == 'LIMITED' %}
                    <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                    <span class="text-warning">Limited</span>
                  {% else %}
                    <span class="text-muted">{{ account.get_status_display }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="account-badges">
                {% if account.proxy %}
                  {% if account.proxy.is_active %}
                    <span class="badge-custom badge-proxy-ok"><i class="bi bi-shield-check me-1"></i>Proxy OK</span>
                  {% else %}
                    <span class="badge-custom badge-proxy-bad"><i class="bi bi-exclamation-octagon me-1"></i>Proxy Inactive</span>
                  {% endif %}
                {% endif %}
                {% with dev=account.device %}
                  {% if dev %}
                    {% with ds=dev.device_settings %}
                      <span class="badge-custom" style="background: rgba(59, 130, 246, 0.1); color: #2563eb; border-color: rgba(59, 130, 246, 0.3);"><i class="bi bi-phone me-1"></i>Device {{ ds.model|default:'?' }} (Android {{ ds.android_version|default:'?' }})</span>
                    {% endwith %}
                    {% if dev.session_settings %}
                      <span class="badge-custom" style="background: rgba(34, 197, 94, 0.1); color: #059669; border-color: rgba(34, 197, 94, 0.3);"><i class="bi bi-key me-1"></i>Session saved</span>
                    {% else %}
                      <span class="badge-custom" style="background: rgba(148,163,184,.15); color: #475569; border-color: rgba(148,163,184,.35);"><i class="bi bi-key me-1"></i>No session</span>
                    {% endif %}
                  {% else %}
                    <span class="badge-custom" style="background: rgba(148,163,184,.15); color: #475569; border-color: rgba(148,163,184,.35);"><i class="bi bi-phone me-1"></i>No device</span>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </label>
        </div>
        {% empty %}
        <div class="col-12 text-center text-muted py-4">No accounts found</div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% if form.selected_accounts.errors %}
  <div class="mt-2">
    <div class="alert alert-danger py-2">
      {% for err in form.selected_accounts.errors %}
      <div>{{ err }}</div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="mb-3">
    <label class="form-label">{{ form.photos.label }}</label>
    <div class="photo-upload-area" id="photoUploadArea">
      <div class="upload-content">
        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
        <h5>Drop photos here or click to select</h5>
        <p class="text-muted mb-0">Supports JPG, JPEG, PNG files</p>
        <p class="text-muted small">Photos will be distributed among selected accounts</p>
      </div>
    </div>
    <input type="file" name="photos" id="id_photos" multiple accept=".jpg,.jpeg,.png" style="display: none;">
    <div class="photo-preview-grid" id="photoPreviewGrid"></div>
    {% if form.photos.help_text %}<div class="form-text">{{ form.photos.help_text }}</div>{% endif %}
    {% if form.photos.errors %}
    <div class="text-danger small mt-1">{% for err in form.photos.errors %}<div>{{ err }}</div>{% endfor %}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">{{ form.captions_file.label }}</label>
    {{ form.captions_file }}
    {% if form.captions_file.help_text %}<div class="form-text">{{ form.captions_file.help_text }}</div>{% endif %}
    {% if form.captions_file.errors %}
    <div class="text-danger small mt-1">{% for err in form.captions_file.errors %}<div>{{ err }}</div>{% endfor %}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">{{ form.caption.label }}</label>
    {{ form.caption }}
    <div class="form-text">This caption will be used if no captions file is provided or if there are fewer captions than photos.</div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">{{ form.mentions.label }}</label>
      {{ form.mentions }}
      {% if form.mentions.help_text %}<div class="form-text">{{ form.mentions.help_text }}</div>{% endif %}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ form.location.label }}</label>
      {{ form.location }}
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-md-3">
      <label class="form-label">{{ form.delay_min_sec.label }}</label>
      {{ form.delay_min_sec }}
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ form.delay_max_sec.label }}</label>
      {{ form.delay_max_sec }}
    </div>
  </div>

  <div id="nonActiveWarningContainer" class="mt-3"></div>

  <div class="mt-4 d-flex gap-2 justify-content-end">
    <button type="submit" class="btn btn-success"><i class="bi bi-rocket-takeoff me-2"></i>Start Posting</button>
    <a href="{% url 'dashboard' %}" class="btn btn-light">Cancel</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function debounce(func, wait) { let timeout; return function(...args){ clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); } }
function updateCardSelection(cb){ const card = cb.closest('.account-item').querySelector('.account-card'); if(cb.checked){ card.classList.add('selected'); } else { card.classList.remove('selected'); } }
function updateCounter(){
  const checkboxes = document.querySelectorAll('.account-checkbox');
  const selected = Array.from(checkboxes).filter(cb => cb.checked);
  document.getElementById('selectedCount').textContent = selected.length;
  const proxyCount = selected.filter(cb => cb.closest('.account-item').dataset.hasProxy === 'true').length;
  document.getElementById('proxyCount').textContent = proxyCount;
  const problemsCount = selected.filter(cb => cb.closest('.account-item').dataset.proxyActive === 'false').length;
  document.getElementById('problemsCount').textContent = problemsCount;
}
function validateAccountSelection(){
  const anyChecked = Array.from(document.querySelectorAll('.account-checkbox')).some(cb => cb.checked);
  if(!anyChecked){
    const container = document.getElementById('nonActiveWarningContainer');
    container.innerHTML = '<div class="alert alert-warning">Please select at least one account</div>';
    return false;
  }
  
  if(selectedPhotos.length === 0){
    const container = document.getElementById('nonActiveWarningContainer');
    container.innerHTML = '<div class="alert alert-warning">Please select at least one photo</div>';
    return false;
  }
  
  return true;
}

document.addEventListener('DOMContentLoaded', function(){
  const searchInput = document.getElementById('accountSearch');
  const accountItems = document.querySelectorAll('.account-item');
  const accountCheckboxes = document.querySelectorAll('.account-checkbox');
  const accountsWidget = document.getElementById('accountsWidget');
  const clientFilter = document.getElementById('client-filter');
  const tagFilter = document.getElementById('tag-filter');
  const pageSizeSelect = document.getElementById('pageSize');
  const paginationInfo = document.getElementById('paginationInfo');
  const paginationText = document.getElementById('paginationText');
  const paginationControls = document.getElementById('paginationControls');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');
  let currentView = 'card';
  let currentPage = 1;
  let pageSize = 50;
  let totalAccounts = accountItems.length;
  let filteredAccounts = [...accountItems];
  let visibleAccounts = [];

  document.querySelectorAll('.view-toggle-btn').forEach(btn => { btn.addEventListener('click', function(){ document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); currentView = this.dataset.view; updateViewMode(); }); });

  // Client filter functionality
  if (clientFilter) {
    clientFilter.addEventListener('change', function() {
      filterAndPaginate();
    });
  }

  // Tag filter functionality
  if (tagFilter) {
    tagFilter.addEventListener('change', function() {
      filterAndPaginate();
    });
  }

  // Page size selector
  if (pageSizeSelect) {
    pageSizeSelect.addEventListener('change', function() {
      pageSize = this.value === 'all' ? 9999 : parseInt(this.value);
      currentPage = 1;
      filterAndPaginate();
    });
  }

  // Pagination controls
  if (prevPageBtn) {
    prevPageBtn.addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        filterAndPaginate();
      }
    });
  }

  if (nextPageBtn) {
    nextPageBtn.addEventListener('click', function() {
      const totalPages = Math.ceil(filteredAccounts.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        filterAndPaginate();
      }
    });
  }

  function updateViewMode(){ accountsWidget.className = accountsWidget.className.replace(/\b(compact-mode|list-mode)\b/g, '').trim(); if(currentView === 'compact'){ accountsWidget.classList.add('compact-mode'); updateColumnClasses('col-lg-4 col-md-6'); } else if(currentView === 'list'){ accountsWidget.classList.add('list-mode'); updateColumnClasses('col-12'); } else { updateColumnClasses('col-lg-6 col-md-12'); } }
  function updateColumnClasses(newClasses){ accountItems.forEach(item => { item.className = 'account-item ' + newClasses; }); }

  function filterAndPaginate(){
    const q = (searchInput.value || '').toLowerCase().trim();

    // Apply filters
    filteredAccounts = Array.from(accountItems).filter(item => {
      const username = item.dataset.username || '';
      const clientId = item.dataset.clientId || '';
      const tagId = item.dataset.tagId || '';

      // Search filter
      let match = username.includes(q);

      // Client filter
      if (match && clientFilter && clientFilter.value) {
        if (clientFilter.value === 'no_client') {
          // Show only accounts without client
          if (clientId !== '') {
            match = false;
          }
        } else {
          // Show only accounts with selected client
          if (clientId !== clientFilter.value) {
            match = false;
          }
        }
      }

      // Tag filter
      if (match && tagFilter && tagFilter.value) {
        if (tagFilter.value === 'no_tag') {
          // Show only accounts without tag
          if (tagId !== '') {
            match = false;
          }
        } else {
          // Show only accounts with selected tag
          if (tagId !== tagFilter.value) {
            match = false;
          }
        }
      }

      return match;
    });

    // Calculate pagination
    const totalFiltered = filteredAccounts.length;
    const totalPages = pageSize === 9999 ? 1 : Math.ceil(totalFiltered / pageSize);

    // Adjust current page if necessary
    if (currentPage > totalPages) {
      currentPage = Math.max(1, totalPages);
    }

    const startIndex = pageSize === 9999 ? 0 : (currentPage - 1) * pageSize;
    const endIndex = pageSize === 9999 ? totalFiltered : Math.min(startIndex + pageSize, totalFiltered);

    visibleAccounts = filteredAccounts.slice(startIndex, endIndex);

    // Hide all accounts first
    accountItems.forEach(item => {
      item.style.display = 'none';
    });

    // Show visible accounts
    visibleAccounts.forEach(item => {
      item.style.display = '';
    });

    // Update pagination info
    updatePaginationInfo(startIndex + 1, endIndex, totalFiltered, totalPages);
    updateCounter();
  }

  function updatePaginationInfo(start, end, total, totalPages) {
    if (total === 0) {
      paginationText.textContent = 'No accounts found';
      paginationControls.style.display = 'none';
    } else if (pageSize === 9999) {
      paginationText.textContent = `Showing all ${total} accounts`;
      paginationControls.style.display = 'none';
    } else {
      paginationText.textContent = `Showing ${start}-${end} of ${total} accounts`;
      paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }
  }

  searchInput.addEventListener('input', debounce(filterAndPaginate, 200));

  // Bulk selection actions
  document.getElementById('selectAll').addEventListener('click', function(){
    visibleAccounts.forEach(item => {
      const cb = item.querySelector('.account-checkbox');
      cb.checked = true;
      updateCardSelection(cb);
    });
    updateCounter();
  });

  document.getElementById('selectNone').addEventListener('click', function(){
    accountCheckboxes.forEach(cb => {
      cb.checked = false;
      updateCardSelection(cb);
    });
    updateCounter();
  });

  document.getElementById('selectRandom').addEventListener('click', function(){
    // First clear all
    accountCheckboxes.forEach(cb => {
      cb.checked = false;
      updateCardSelection(cb);
    });

    // Then select 10 random visible accounts
    const randomTen = visibleAccounts.sort(() => 0.5 - Math.random()).slice(0, Math.min(10, visibleAccounts.length));

    randomTen.forEach(item => {
      const cb = item.querySelector('.account-checkbox');
      cb.checked = true;
      updateCardSelection(cb);
    });

    updateCounter();
  });

  // Initialize pagination
  filterAndPaginate();
  accountCheckboxes.forEach(cb => { cb.addEventListener('change', function(){ updateCardSelection(cb); updateCounter(); }); });

  // Photo upload functionality
  const photoUploadArea = document.getElementById('photoUploadArea');
  const photoInput = document.getElementById('id_photos');
  const photoPreviewGrid = document.getElementById('photoPreviewGrid');
  let selectedPhotos = [];

  // Click to select files
  photoUploadArea.addEventListener('click', () => {
    photoInput.click();
  });

  // File input change
  photoInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  // Drag and drop
  photoUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    photoUploadArea.classList.add('dragover');
  });

  photoUploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    photoUploadArea.classList.remove('dragover');
  });

  photoUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    photoUploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });

  function handleFiles(files) {
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    const validFiles = Array.from(files).filter(file => validTypes.includes(file.type));
    
    if (validFiles.length === 0) {
      alert('Please select only JPG, JPEG, or PNG files.');
      return;
    }

    validFiles.forEach(file => {
      if (!selectedPhotos.find(photo => photo.name === file.name)) {
        selectedPhotos.push(file);
        createPhotoPreview(file);
      }
    });

    updatePhotoInput();
    updateUploadAreaText();
  }

  function createPhotoPreview(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const previewItem = document.createElement('div');
      previewItem.className = 'photo-preview-item';
      previewItem.innerHTML = `
        <img src="${e.target.result}" alt="${file.name}">
        <button type="button" class="remove-btn" onclick="removePhoto('${file.name}')">
          <i class="bi bi-x"></i>
        </button>
        <div class="filename">${file.name}</div>
      `;
      photoPreviewGrid.appendChild(previewItem);
    };
    reader.readAsDataURL(file);
  }

  function removePhoto(filename) {
    selectedPhotos = selectedPhotos.filter(photo => photo.name !== filename);
    updatePhotoInput();
    updateUploadAreaText();
    
    // Remove preview
    const previewItems = photoPreviewGrid.querySelectorAll('.photo-preview-item');
    previewItems.forEach(item => {
      if (item.querySelector('.filename').textContent === filename) {
        item.remove();
      }
    });
  }

  function updatePhotoInput() {
    // Create a new DataTransfer object
    const dataTransfer = new DataTransfer();
    selectedPhotos.forEach(photo => {
      dataTransfer.items.add(photo);
    });
    photoInput.files = dataTransfer.files;
  }

  function updateUploadAreaText() {
    const uploadContent = photoUploadArea.querySelector('.upload-content');
    if (selectedPhotos.length > 0) {
      uploadContent.innerHTML = `
        <i class="bi bi-check-circle-fill" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
        <h5>${selectedPhotos.length} photo${selectedPhotos.length !== 1 ? 's' : ''} selected</h5>
        <p class="text-muted mb-0">Click to add more photos</p>
        <p class="text-muted small">Photos will be distributed among selected accounts</p>
      `;
    } else {
      uploadContent.innerHTML = `
        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
        <h5>Drop photos here or click to select</h5>
        <p class="text-muted mb-0">Supports JPG, JPEG, PNG files</p>
        <p class="text-muted small">Photos will be distributed among selected accounts</p>
      `;
    }
  }

  // Make removePhoto globally accessible
  window.removePhoto = removePhoto;
});
</script>
{% endblock %}


