{% extends 'uploader/base.html' %}

{% block title %}Create Photo Post - Instagram Uploader{% endblock %}

{% block extra_css %}
<style>
  .accounts-controls { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px 12px 0 0; }
  .search-wrapper { position: relative; }
  .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.7); }
  .accounts-controls .form-control { border-radius: 25px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; padding-left: 2.5rem; }
  .accounts-grid { padding: 1rem; max-height: 600px; overflow-y: auto; background: #f8f9fb; border-radius: 0 0 12px 12px; position: relative; }
  .account-item { margin-bottom: 0.75rem; }
  .account-card { border: 2px solid #e9ecef; border-radius: 12px; background: white; padding: 1rem; position: relative; display: flex; gap: 12px; align-items: center; cursor: pointer; }
  .account-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); }
  .account-checkbox { position: absolute; opacity: 0; pointer-events: none; }
  .custom-checkbox { width: 22px; height: 22px; border: 2px solid #dee2e6; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: white; flex-shrink: 0; }
  .custom-checkbox i { color: white; font-size: 14px; opacity: 0; }
  .account-checkbox:checked ~ .account-card .custom-checkbox { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; }
  .account-checkbox:checked ~ .account-card .custom-checkbox i { opacity: 1; }
  .account-username { font-weight: 600; color: #2d3748; }
  .account-stats { color: #718096; font-size: 0.875rem; }
  .account-badges { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .badge-custom { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.72rem; font-weight: 500; border: 1px solid; }
  .badge-proxy-ok { background: rgba(34, 197, 94, 0.1); color: #059669; border-color: rgba(34, 197, 94, 0.3); }
  .badge-proxy-bad { background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(239, 68, 68, 0.3); }
  .summary-bar { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
  .view-toggle { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; padding: 0.25rem; display: inline-flex; gap: 4px; }
  .view-toggle-btn { background: transparent; border: none; color: #fff; padding: 0.3rem 0.7rem; border-radius: 15px; cursor: pointer; }
  .view-toggle-btn.active { background: white; color: #667eea; }
  .compact-mode .account-card { padding: 0.6rem; border-radius: 8px; border-width: 1px; }
  .compact-mode .custom-checkbox { width: 20px; height: 20px; border-width: 1px; border-radius: 4px; }
  .compact-mode .badge-custom { padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.65rem; }
  .list-mode .account-item { margin-bottom: 0.25rem; }
  .list-mode .account-card { padding: 0.75rem 1rem; border-radius: 6px; border-width: 1px; }
  
  /* Photo upload styles */
  .photo-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    background: #f8f9fb;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .photo-upload-area:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }
  .photo-upload-area.dragover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    transform: scale(1.02);
  }
  .photo-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  .photo-preview-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    border: 2px solid #e9ecef;
  }
  .photo-preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }
  .photo-preview-item .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
  }
  .photo-preview-item .filename {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    font-size: 11px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="fw-bold mb-4"><i class="bi bi-image me-2"></i>Create Photo Post</h2>

<form method="post" enctype="multipart/form-data" onsubmit="return validateAccountSelection()">
  {% csrf_token %}

  {% if form.non_field_errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">
      {% for err in form.non_field_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="summary-bar" id="accountsSummary">
    <div class="d-flex align-items-center gap-3">
      <div>
        <div class="fw-bold" id="selectedCount">0</div>
        <div class="text-muted small" id="totalCount">of {{ form.selected_accounts.field.queryset.count }} accounts selected</div>
      </div>
      <div class="d-flex gap-3 text-muted small" id="summaryStats">
        <div><i class="bi bi-check-circle text-success"></i> <span id="activeCount">{{ form.selected_accounts.field.queryset|length }}</span> active</div>
        <div><i class="bi bi-shield-check"></i> <span id="proxyCount">0</span> with proxy</div>
        <div><i class="bi bi-exclamation-triangle text-warning"></i> <span id="problemsCount">0</span> issues</div>
      </div>
    </div>
    <div style="min-width:240px">
      <div class="search-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" id="accountSearch" class="form-control" placeholder="Search accounts by username...">
      </div>
    </div>
  </div>

  <div class="card mb-3 border-0 shadow-sm" id="accountsWidget">
    <div class="accounts-controls">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="view-toggle">
            <button type="button" class="view-toggle-btn active" data-view="card"><i class="bi bi-grid-3x3-gap"></i> Cards</button>
            <button type="button" class="view-toggle-btn" data-view="compact"><i class="bi bi-list"></i> Compact</button>
            <button type="button" class="view-toggle-btn" data-view="list"><i class="bi bi-list-ul"></i> List</button>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-light btn-sm" id="selectAll"><i class="bi bi-check-all"></i> Select All</button>
            <button type="button" class="btn btn-light btn-sm" id="selectNone"><i class="bi bi-x"></i> Clear</button>
            <button type="button" class="btn btn-light btn-sm" id="selectRandom"><i class="bi bi-shuffle"></i> Random 10</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accounts-grid">
      <div class="row" id="accountsContainer">
        {% for account in form.selected_accounts.field.queryset %}
        <div class="col-lg-6 col-md-12 account-item"
             data-username="{{ account.username|lower }}"
             data-has-proxy="{{ account.proxy|yesno:'true,false' }}"
             data-proxy-active="{% if account.proxy %}{{ account.proxy.is_active|yesno:'true,false' }}{% else %}false{% endif %}"
             data-status="{{ account.status|lower }}">
          <input class="account-checkbox" type="checkbox" name="selected_accounts" value="{{ account.id }}" id="account_{{ account.id }}">
          <label class="account-card" for="account_{{ account.id }}">
            <div class="custom-checkbox"><i class="bi bi-check"></i></div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <div class="account-username">{{ account.username }}</div>
                <div class="account-stats">
                  {% if account.status == 'ACTIVE' %}
                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                    <span class="text-success">Active</span>
                  {% elif account.status == 'BLOCKED' %}
                    <i class="bi bi-x-circle-fill text-danger me-1"></i>
                    <span class="text-danger">Blocked</span>
                  {% elif account.status == 'LIMITED' %}
                    <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                    <span class="text-warning">Limited</span>
                  {% else %}
                    <span class="text-muted">{{ account.get_status_display }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="account-badges">
                {% if account.proxy %}
                  {% if account.proxy.is_active %}
                    <span class="badge-custom badge-proxy-ok"><i class="bi bi-shield-check me-1"></i>Proxy OK</span>
                  {% else %}
                    <span class="badge-custom badge-proxy-bad"><i class="bi bi-exclamation-octagon me-1"></i>Proxy Inactive</span>
                  {% endif %}
                {% endif %}
                {% with dev=account.device %}
                  {% if dev %}
                    {% with ds=dev.device_settings %}
                      <span class="badge-custom" style="background: rgba(59, 130, 246, 0.1); color: #2563eb; border-color: rgba(59, 130, 246, 0.3);"><i class="bi bi-phone me-1"></i>Device {{ ds.model|default:'?' }} (Android {{ ds.android_version|default:'?' }})</span>
                    {% endwith %}
                    {% if dev.session_settings %}
                      <span class="badge-custom" style="background: rgba(34, 197, 94, 0.1); color: #059669; border-color: rgba(34, 197, 94, 0.3);"><i class="bi bi-key me-1"></i>Session saved</span>
                    {% else %}
                      <span class="badge-custom" style="background: rgba(148,163,184,.15); color: #475569; border-color: rgba(148,163,184,.35);"><i class="bi bi-key me-1"></i>No session</span>
                    {% endif %}
                  {% else %}
                    <span class="badge-custom" style="background: rgba(148,163,184,.15); color: #475569; border-color: rgba(148,163,184,.35);"><i class="bi bi-phone me-1"></i>No device</span>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </label>
        </div>
        {% empty %}
        <div class="col-12 text-center text-muted py-4">No accounts found</div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% if form.selected_accounts.errors %}
  <div class="mt-2">
    <div class="alert alert-danger py-2">
      {% for err in form.selected_accounts.errors %}
      <div>{{ err }}</div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="mb-3">
    <label class="form-label">{{ form.photos.label }}</label>
    <div class="photo-upload-area" id="photoUploadArea">
      <div class="upload-content">
        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
        <h5>Drop photos here or click to select</h5>
        <p class="text-muted mb-0">Supports JPG, JPEG, PNG files</p>
        <p class="text-muted small">Photos will be distributed among selected accounts</p>
      </div>
    </div>
    <input type="file" name="photos" id="id_photos" multiple accept=".jpg,.jpeg,.png" style="display: none;">
    <div class="photo-preview-grid" id="photoPreviewGrid"></div>
    {% if form.photos.help_text %}<div class="form-text">{{ form.photos.help_text }}</div>{% endif %}
    {% if form.photos.errors %}
    <div class="text-danger small mt-1">{% for err in form.photos.errors %}<div>{{ err }}</div>{% endfor %}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">{{ form.captions_file.label }}</label>
    {{ form.captions_file }}
    {% if form.captions_file.help_text %}<div class="form-text">{{ form.captions_file.help_text }}</div>{% endif %}
    {% if form.captions_file.errors %}
    <div class="text-danger small mt-1">{% for err in form.captions_file.errors %}<div>{{ err }}</div>{% endfor %}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">{{ form.caption.label }}</label>
    {{ form.caption }}
    <div class="form-text">This caption will be used if no captions file is provided or if there are fewer captions than photos.</div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">{{ form.mentions.label }}</label>
      {{ form.mentions }}
      {% if form.mentions.help_text %}<div class="form-text">{{ form.mentions.help_text }}</div>{% endif %}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ form.location.label }}</label>
      {{ form.location }}
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-md-3">
      <label class="form-label">{{ form.delay_min_sec.label }}</label>
      {{ form.delay_min_sec }}
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ form.delay_max_sec.label }}</label>
      {{ form.delay_max_sec }}
    </div>
  </div>

  <div id="nonActiveWarningContainer" class="mt-3"></div>

  <div class="mt-4 d-flex gap-2 justify-content-end">
    <button type="submit" class="btn btn-success"><i class="bi bi-rocket-takeoff me-2"></i>Start Posting</button>
    <a href="{% url 'dashboard' %}" class="btn btn-light">Cancel</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function debounce(func, wait) { let timeout; return function(...args){ clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); } }
function updateCardSelection(cb){ const card = cb.closest('.account-item').querySelector('.account-card'); if(cb.checked){ card.classList.add('selected'); } else { card.classList.remove('selected'); } }
function updateCounter(){
  const checkboxes = document.querySelectorAll('.account-checkbox');
  const selected = Array.from(checkboxes).filter(cb => cb.checked);
  document.getElementById('selectedCount').textContent = selected.length;
  const proxyCount = selected.filter(cb => cb.closest('.account-item').dataset.hasProxy === 'true').length;
  document.getElementById('proxyCount').textContent = proxyCount;
  const problemsCount = selected.filter(cb => cb.closest('.account-item').dataset.proxyActive === 'false').length;
  document.getElementById('problemsCount').textContent = problemsCount;
}
function validateAccountSelection(){
  const anyChecked = Array.from(document.querySelectorAll('.account-checkbox')).some(cb => cb.checked);
  if(!anyChecked){
    const container = document.getElementById('nonActiveWarningContainer');
    container.innerHTML = '<div class="alert alert-warning">Please select at least one account</div>';
    return false;
  }
  
  if(selectedPhotos.length === 0){
    const container = document.getElementById('nonActiveWarningContainer');
    container.innerHTML = '<div class="alert alert-warning">Please select at least one photo</div>';
    return false;
  }
  
  return true;
}

document.addEventListener('DOMContentLoaded', function(){
  const searchInput = document.getElementById('accountSearch');
  const accountItems = document.querySelectorAll('.account-item');
  const accountCheckboxes = document.querySelectorAll('.account-checkbox');
  const accountsWidget = document.getElementById('accountsWidget');
  let currentView = 'card';

  document.querySelectorAll('.view-toggle-btn').forEach(btn => { btn.addEventListener('click', function(){ document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); currentView = this.dataset.view; updateViewMode(); }); });
  function updateViewMode(){ accountsWidget.className = accountsWidget.className.replace(/\b(compact-mode|list-mode)\b/g, '').trim(); if(currentView === 'compact'){ accountsWidget.classList.add('compact-mode'); updateColumnClasses('col-lg-4 col-md-6'); } else if(currentView === 'list'){ accountsWidget.classList.add('list-mode'); updateColumnClasses('col-12'); } else { updateColumnClasses('col-lg-6 col-md-12'); } }
  function updateColumnClasses(newClasses){ accountItems.forEach(item => { item.className = 'account-item ' + newClasses; }); }
  function filterList(){ const q = (searchInput.value || '').toLowerCase().trim(); accountItems.forEach(item => { const match = (item.dataset.username || '').includes(q); item.style.display = match ? '' : 'none'; }); }
  searchInput.addEventListener('input', debounce(filterList, 200));
  document.getElementById('selectAll').addEventListener('click', function(){ accountItems.forEach(item => { if(item.style.display !== 'none'){ const cb = item.querySelector('.account-checkbox'); cb.checked = true; updateCardSelection(cb); } }); updateCounter(); });
  document.getElementById('selectNone').addEventListener('click', function(){ accountCheckboxes.forEach(cb => { cb.checked = false; updateCardSelection(cb); }); updateCounter(); });
  document.getElementById('selectRandom').addEventListener('click', function(){ const visible = Array.from(accountItems).filter(i => i.style.display !== 'none'); const randomTen = visible.sort(() => .5 - Math.random()).slice(0, 10); accountCheckboxes.forEach(cb => { cb.checked = false; updateCardSelection(cb); }); randomTen.forEach(item => { const cb = item.querySelector('.account-checkbox'); cb.checked = true; updateCardSelection(cb); }); updateCounter(); });
  accountCheckboxes.forEach(cb => { cb.addEventListener('change', function(){ updateCardSelection(cb); updateCounter(); }); });

  // Photo upload functionality
  const photoUploadArea = document.getElementById('photoUploadArea');
  const photoInput = document.getElementById('id_photos');
  const photoPreviewGrid = document.getElementById('photoPreviewGrid');
  let selectedPhotos = [];

  // Click to select files
  photoUploadArea.addEventListener('click', () => {
    photoInput.click();
  });

  // File input change
  photoInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  // Drag and drop
  photoUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    photoUploadArea.classList.add('dragover');
  });

  photoUploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    photoUploadArea.classList.remove('dragover');
  });

  photoUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    photoUploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });

  function handleFiles(files) {
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    const validFiles = Array.from(files).filter(file => validTypes.includes(file.type));
    
    if (validFiles.length === 0) {
      alert('Please select only JPG, JPEG, or PNG files.');
      return;
    }

    validFiles.forEach(file => {
      if (!selectedPhotos.find(photo => photo.name === file.name)) {
        selectedPhotos.push(file);
        createPhotoPreview(file);
      }
    });

    updatePhotoInput();
    updateUploadAreaText();
  }

  function createPhotoPreview(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const previewItem = document.createElement('div');
      previewItem.className = 'photo-preview-item';
      previewItem.innerHTML = `
        <img src="${e.target.result}" alt="${file.name}">
        <button type="button" class="remove-btn" onclick="removePhoto('${file.name}')">
          <i class="bi bi-x"></i>
        </button>
        <div class="filename">${file.name}</div>
      `;
      photoPreviewGrid.appendChild(previewItem);
    };
    reader.readAsDataURL(file);
  }

  function removePhoto(filename) {
    selectedPhotos = selectedPhotos.filter(photo => photo.name !== filename);
    updatePhotoInput();
    updateUploadAreaText();
    
    // Remove preview
    const previewItems = photoPreviewGrid.querySelectorAll('.photo-preview-item');
    previewItems.forEach(item => {
      if (item.querySelector('.filename').textContent === filename) {
        item.remove();
      }
    });
  }

  function updatePhotoInput() {
    // Create a new DataTransfer object
    const dataTransfer = new DataTransfer();
    selectedPhotos.forEach(photo => {
      dataTransfer.items.add(photo);
    });
    photoInput.files = dataTransfer.files;
  }

  function updateUploadAreaText() {
    const uploadContent = photoUploadArea.querySelector('.upload-content');
    if (selectedPhotos.length > 0) {
      uploadContent.innerHTML = `
        <i class="bi bi-check-circle-fill" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
        <h5>${selectedPhotos.length} photo${selectedPhotos.length !== 1 ? 's' : ''} selected</h5>
        <p class="text-muted mb-0">Click to add more photos</p>
        <p class="text-muted small">Photos will be distributed among selected accounts</p>
      `;
    } else {
      uploadContent.innerHTML = `
        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
        <h5>Drop photos here or click to select</h5>
        <p class="text-muted mb-0">Supports JPG, JPEG, PNG files</p>
        <p class="text-muted small">Photos will be distributed among selected accounts</p>
      `;
    }
  }

  // Make removePhoto globally accessible
  window.removePhoto = removePhoto;
});
</script>
{% endblock %}


