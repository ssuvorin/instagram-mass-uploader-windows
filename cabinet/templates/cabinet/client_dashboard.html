{% extends "uploader/base.html" %}
{% load static %}

{% block title %}Cabinet â€” Client Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cabinet-theme.css' %}">
<!-- mr.Booster Favicons for Cabinet -->
<link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">
<link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
<link rel="icon" type="image/svg+xml" href="{% static 'images/mrbooster-logo-color.svg' %}">

<!-- Chart.js with mr.Booster colors -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/cabinet-charts.js' %}"></script>

<style>
/* Override navbar brand for cabinet pages */
.navbar-brand {
  display: flex !important;
  align-items: center !important;
}

.navbar-brand img {
  height: 32px;
  margin-right: 8px;
}
</style>
<style>
/* Cabinet theme overrides */

@media (max-width: 768px) {
  .mobile-header {
    flex-direction: column;
    align-items: stretch !important;
    gap: 1rem;
  }
  
  .mobile-btn-group {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .mobile-btn-group .btn {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
  }
  
  .mobile-card-grid {
    grid-template-columns: 1fr !important;
  }
  
  .mobile-chart-container {
    height: 200px !important;
  }
  
  .mobile-table {
    font-size: 0.8rem;
  }
  
  .mobile-table th,
  .mobile-table td {
    padding: 0.5rem 0.25rem;
    white-space: nowrap;
  }
  
  .mobile-hide {
    display: none !important;
  }
}

@media (max-width: 576px) {
  .client-title {
    font-size: 1.5rem;
    line-height: 1.2;
    margin-bottom: 0.5rem;
  }
  
  .mobile-stack {
    flex-direction: column !important;
    gap: 0.5rem !important;
  }
  
  .mobile-full-width {
    width: 100% !important;
  }
}
</style>
{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-xl">
    <div class="container">
        <a class="navbar-brand app-logo" href="{% url 'dashboard' %}">
            <img src="{% static 'images/mrbooster-logo-black.svg' %}" alt="mr.Booster">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto scrollable-navbar">
                {% if user.is_superuser %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if active_tab == 'dashboard' or active_tab == 'tiktok_dashboard' or active_tab == 'yt_shorts_dashboard' %}active{% endif %}" href="#" id="dashDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid"></i> Dashboard
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="dashDropdown">
                        <li><a class="dropdown-item {% if active_tab == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}"><i class="bi bi-instagram me-2"></i>Instagram</a></li>
                        <li><a class="dropdown-item {% if active_tab == 'tiktok_dashboard' %}active{% endif %}" href="{% url 'tiktok_dashboard' %}"><i class="bi bi-music-note-beamed me-2"></i>TikTok</a></li>
                        <li><a class="dropdown-item {% if active_tab == 'yt_shorts_dashboard' %}active{% endif %}" href="{% url 'yt_shorts_dashboard' %}"><i class="bi bi-youtube me-2 text-danger"></i>YouTube Shorts</a></li>
                    </ul>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'cabinet' %}active{% endif %}" href="{% url 'cabinet_dashboard' %}">
                        <i class="bi bi-person-badge"></i> Cabinet
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="accountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ user.username }}
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="accountDropdown">
                        <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="bi bi-house me-2"></i>Dashboard</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="cabinet-theme">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mobile-header">
        <div>
        <div>
          <h1 class="dashboard-title">Client Dashboard</h1>
          <p class="dashboard-subtitle">{{ client.name }}</p>
        </div>
        </div>
        <div class="btn-toolbar gap-2 mobile-btn-group">
          <!-- Time Period Selector -->
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" id="timePeriodAll" onclick="changeTimePeriod(null)">
              <i class="bi bi-calendar-range"></i>
              <span class="d-none d-sm-inline"> All Time</span>
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="timePeriod30" onclick="changeTimePeriod(30)">
              <i class="bi bi-calendar-week"></i>
              <span class="d-none d-sm-inline"> 30 Days</span>
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="timePeriod7" onclick="changeTimePeriod(7)">
              <i class="bi bi-calendar-day"></i>
              <span class="d-none d-sm-inline"> 7 Days</span>
            </button>
          </div>
          <a class="btn btn-success btn-sm" href="{% url 'cabinet_export_excel' %}">
            <i class="bi bi-file-earmark-excel"></i>
            <span class="d-none d-sm-inline"> Excel</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- KPI Cards -->
    <div class="stats-grid mobile-card-grid">
      <div class="kpi-card fade-in">
        <div class="kpi-value">{{ kpi_total_videos|default:0 }}</div>
        <div class="kpi-label">Total Videos</div>
      </div>
      <div class="kpi-card fade-in">
        <div class="kpi-value">{{ kpi_total_views|default:0|floatformat:0 }}</div>
        <div class="kpi-label">Total Views</div>
      </div>
      <div class="kpi-card fade-in">
        <div class="kpi-value">{{ kpi_avg_per_video|default:0|floatformat:0 }}</div>
        <div class="kpi-label">Avg per Video</div>
      </div>
      <div class="kpi-card fade-in">
        <div class="kpi-value">{{ kpi_engagement_rate|default:0|floatformat:2 }}%</div>
        <div class="kpi-label">Engagement Rate</div>
      </div>
    </div>

    <!-- Social Networks Breakdown -->
    {% if network_breakdown %}
    <div class="card mb-8 slide-up">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-diagram-3 me-2"></i>Analytics by Social Networks
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 mobile-table">
            <thead>
              <tr>
                <th>Network</th>
                <th>Posts</th>
                <th>Views</th>
                <th>Avg Views</th>
                <th>Engagement</th>
                <th>Accounts</th>
              </tr>
            </thead>
            <tbody>
              {% for network in network_breakdown %}
              <tr>
                <td>
                  {% if network.network == 'INSTAGRAM' %}
                    <span class="network-badge instagram">
                      <i class="bi bi-instagram"></i>{{ network.network_display }}
                    </span>
                  {% elif network.network == 'YOUTUBE' %}
                    <span class="network-badge youtube">
                      <i class="bi bi-youtube"></i>{{ network.network_display }}
                    </span>
                  {% elif network.network == 'TIKTOK' %}
                    <span class="network-badge tiktok">
                      <i class="bi bi-music-note-beamed"></i>{{ network.network_display }}
                    </span>
                  {% else %}
                    <span class="badge badge-secondary">{{ network.network_display }}</span>
                  {% endif %}
                </td>
                <td>{{ network.total_posts|default:0 }}</td>
                <td>{{ network.total_views|default:0|floatformat:0 }}</td>
                <td>{{ network.average_views|default:0|floatformat:0 }}</td>
                <td>{{ network.engagement_rate|default:0|floatformat:2 }}%</td>
                <td>{{ network.total_accounts|default:0 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Advanced Metrics by Network -->
    <div class="card mb-8 slide-up">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-bar-chart me-2"></i>Advanced Metrics by Network
        </h5>
      </div>
      <div class="card-body">
        {% for network in network_breakdown %}
        <div class="mb-6">
          <h6 class="mb-4">
            {% if network.network == 'INSTAGRAM' %}
              <span class="network-badge instagram">
                <i class="bi bi-instagram"></i>{{ network.network_display }}
              </span>
            {% elif network.network == 'YOUTUBE' %}
              <span class="network-badge youtube">
                <i class="bi bi-youtube"></i>{{ network.network_display }}
              </span>
            {% elif network.network == 'TIKTOK' %}
              <span class="network-badge tiktok">
                <i class="bi bi-music-note-beamed"></i>{{ network.network_display }}
              </span>
            {% else %}
              <span class="badge badge-secondary">{{ network.network_display }}</span>
            {% endif %}
          </h6>
          <div class="row g-3">
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.avg_videos_per_account|default:0|floatformat:1 }}</div>
                <div class="kpi-label">Avg Videos/Account</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.max_videos_per_account|default:0 }}</div>
                <div class="kpi-label">Max Videos/Account</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.avg_views_per_video|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Avg Views/Video</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.max_views_per_video|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Max Views/Video</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.avg_views_per_account|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Avg Views/Account</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.max_views_per_account|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Max Views/Account</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.avg_likes_per_video|default:0|floatformat:1 }}</div>
                <div class="kpi-label">Avg Likes/Video</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.max_likes_per_video|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Max Likes/Video</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.avg_likes_per_account|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Avg Likes/Account</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="kpi-card">
                <div class="kpi-value">{{ network.max_likes_per_account|default:0|floatformat:0 }}</div>
                <div class="kpi-label">Max Likes/Account</div>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted mb-0">No network analytics available yet.</p>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Hashtag Analytics -->
    <div class="card mb-8 slide-up">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-hash me-2"></i>Hashtag Analytics
        </h5>
      </div>
      <div class="card-body p-0">
        {% if details %}
        <div class="table-responsive">
          <table class="table table-hover mb-0 mobile-table">
            <thead>
              <tr>
                <th>Hashtag</th>
                <th>Videos</th>
                <th>Views</th>
                <th>Avg Views</th>
                <th>Likes</th>
                <th>Comments</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody>
              {% for d in details %}
              <tr>
                <td>
                  <a href="{% url 'cabinet_hashtag_detail' d.hashtag %}" class="hashtag-tag">
                    #{{ d.hashtag }}
                  </a>
                </td>
                <td>{{ d.total_videos }}</td>
                <td>{{ d.total_views|floatformat:0 }}</td>
                <td>{{ d.average_views|floatformat:0 }}</td>
                <td>{{ d.total_likes|floatformat:0 }}</td>
                <td>{{ d.total_comments|floatformat:0 }}</td>
                <td>{{ d.engagement_rate|floatformat:2 }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-8">
          <i class="bi bi-hash text-muted" style="font-size: 3rem;"></i>
          <h5 class="mt-4 text-muted">No hashtag analytics yet</h5>
          <p class="text-muted">Hashtag analytics will appear here once data is collected.</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Daily Stats Chart -->
    {% if daily_stats %}
    <div class="chart-container mb-8 slide-up">
      <div class="chart-header">
        <h5 class="chart-title">
          <i class="bi bi-graph-up me-2"></i>Daily Analytics (Last 7 Days)
        </h5>
      </div>
      <div class="mobile-chart-container" style="height: 300px;">
        <canvas id="dailyStatsChart"></canvas>
      </div>
    </div>
    {% endif %}

    <!-- Assigned Hashtags -->
    <div class="card mb-8 slide-up">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-tags me-2"></i>Assigned Hashtags
        </h5>
      </div>
      <div class="card-body">
        {% if hashtags %}
        <div class="d-flex flex-wrap gap-2">
          {% for hashtag in hashtags %}
          <a href="{% url 'cabinet_hashtag_detail' hashtag %}" class="hashtag-tag">
            #{{ hashtag }}
          </a>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-6">
          <i class="bi bi-tags text-muted" style="font-size: 2rem;"></i>
          <p class="text-muted mt-3 mb-0">No hashtags assigned yet</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if daily_stats %}
<!-- Hidden data for JavaScript -->
<div id="dailyStatsJson" style="display: none;">{{ daily_stats|safe }}</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('dailyStatsChart').getContext('2d');
    const dailyStats = JSON.parse(document.getElementById('dailyStatsJson').textContent || '[]');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dailyStats.map(stat => stat.day_name),
            datasets: [{
                label: 'Views',
                data: dailyStats.map(stat => stat.total_views),
                borderColor: '#8167FF',
                backgroundColor: 'rgba(129, 103, 255, 0.2)',
                tension: 0.1
            }, {
                label: 'Videos',
                data: dailyStats.map(stat => stat.total_videos),
                borderColor: '#FFE608',
                backgroundColor: 'rgba(255, 230, 8, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});

// Time period selector functionality
function changeTimePeriod(days) {
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('btn-outline-primary');
    });
    
    let activeButton;
    if (days === null) {
        activeButton = document.getElementById('timePeriodAll');
    } else if (days === 30) {
        activeButton = document.getElementById('timePeriod30');
    } else if (days === 7) {
        activeButton = document.getElementById('timePeriod7');
    }
    
    if (activeButton) {
        activeButton.classList.add('active');
        activeButton.classList.remove('btn-outline-primary');
    }
    
    // Reload page with new time period parameter
    const url = new URL(window.location);
    if (days === null) {
        url.searchParams.delete('days');
    } else {
        url.searchParams.set('days', days);
    }
    window.location.href = url.toString();
}

// Set initial active button based on current URL parameter
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days');
    
    if (days === null) {
        document.getElementById('timePeriodAll').classList.add('active');
        document.getElementById('timePeriodAll').classList.remove('btn-outline-primary');
    } else if (days === '30') {
        document.getElementById('timePeriod30').classList.add('active');
        document.getElementById('timePeriod30').classList.remove('btn-outline-primary');
    } else if (days === '7') {
        document.getElementById('timePeriod7').classList.add('active');
        document.getElementById('timePeriod7').classList.remove('btn-outline-primary');
    }
});
</script>
{% endif %}
{% endblock %}