{% extends "uploader/base.html" %}

{% block title %}–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è - Instagram –∏ TikTok{% endblock %}

{% block content %}
<style>
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #333333;
            --accent-color: #ff6b35;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #1a1a1a;
            --light-color: #f8f9fa;
            --text-color: #333333;
            --border-color: #e9ecef;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1400px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
            min-height: 120px;
        }
        
        .header-section h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            max-width: 70%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            z-index: 10;
        }
        
        .stats-btn {
            background: var(--accent-color);
            border: 2px solid var(--accent-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-btn:hover {
            background: #e55a2b;
            border-color: #e55a2b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .tariffs-section {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        .tariffs-section h3 {
            color: var(--dark-color);
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .tariff-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--accent-color);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .tariff-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .tier-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .tier-1 { background: linear-gradient(135deg, var(--accent-color), #e55a2b); color: white; }
        .tier-2 { background: linear-gradient(135deg, var(--warning-color), #e0a800); color: white; }
        .tier-3 { background: linear-gradient(135deg, var(--danger-color), #c82333); color: white; }
        .tier-difficult { background: linear-gradient(135deg, var(--dark-color), #495057); color: white; }
        
        .form-section {
            padding: 2rem;
        }
        
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .form-card h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }
        
        .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #e55a2b);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .result-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .final-cost {
            background: linear-gradient(135deg, var(--accent-color), #e55a2b);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }
        
        .accordion-button {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, var(--accent-color), #e55a2b);
            color: white;
        }
        
        .country-select {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .country-option {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin: 0.25rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .country-option:hover {
            background-color: var(--light-color);
            transform: translateX(5px);
        }
        
        .country-option.selected {
            background-color: var(--accent-color);
            color: white;
            transform: translateX(5px);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 0.5rem;
                border-radius: 15px;
            }
            
            .header-section {
                padding: 1.5rem 1rem;
                min-height: 100px;
            }
            
            .header-section h1 {
                font-size: 1.8rem;
                max-width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .stats-btn {
                font-size: 0.9rem;
                padding: 0.6rem 1.2rem;
            }
            
            .form-section {
                padding: 1rem;
            }
            
            .form-card {
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
            }
            
            .tariffs-section {
                padding: 1rem !important;
                margin: 1rem !important;
            }
            
            .tariff-card {
                margin-bottom: 1rem;
            }
            
            .result-section {
                padding: 1.5rem !important;
                margin: 1rem !important;
            }
            
            .country-select {
                max-height: 300px;
                font-size: 0.9rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column !important;
            }
            
            .accordion-body {
                padding: 1rem;
            }
            
            .form-check {
                flex: 1;
                min-width: 0;
                margin-bottom: 0.5rem;
            }
            
            .form-check-label {
                font-size: 0.9rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .badge {
                font-size: 0.7rem;
                padding: 0.25em 0.5em;
            }
        }
        
        @media (max-width: 480px) {
            .main-container {
                margin: 0.25rem;
            }
            
            .header-section h1 {
                font-size: 1.4rem;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .form-card {
                padding: 1rem !important;
            }
            
            .tariffs-section {
                padding: 0.5rem !important;
                margin: 0.5rem !important;
            }
            
            .result-section {
                padding: 1rem !important;
                margin: 0.5rem !important;
            }
            
            .form-control, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .final-cost {
                font-size: 1.5rem;
                padding: 1.5rem;
            }
            
            .form-check {
                flex: 1 1 100%;
                margin-bottom: 0.75rem;
            }
            
            .form-check-label {
                font-size: 0.85rem;
                line-height: 1.2;
            }
            
            .d-flex.flex-wrap {
                flex-direction: column;
                gap: 0.5rem !important;
            }
        }
</style>

<div class="container-fluid">
    <div class="main-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header-section">
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —à–∞–ø–∫–µ -->
            <div class="header-controls">
                <a href="{% url 'cabinet_agency_dashboard' %}" class="stats-btn">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
            
            <h1><i class="bi bi-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è</h1>
            <p class="lead mb-0">Instagram –∏ TikTok - –ê–≥–µ–Ω—Ç—Å–∫–∏–µ —Ü–µ–Ω—ã</p>
        </div>

        <!-- –¢–∞—Ä–∏—Ñ—ã -->
        <div class="tariffs-section">
            <h3><i class="bi bi-currency-exchange"></i> –¢–∞—Ä–∏—Ñ–Ω–∞—è —Å–µ—Ç–∫–∞</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-1 mb-2">Tier 1</span>
                        <h5>–ü—Ä–µ–º–∏—É–º —Å—Ç—Ä–∞–Ω—ã</h5>
                        <p class="text-muted">–°–®–ê, –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è, –ì–µ—Ä–º–∞–Ω–∏—è, –§—Ä–∞–Ω—Ü–∏—è, –Ø–ø–æ–Ω–∏—è, –ö–∞–Ω–∞–¥–∞, –ê–≤—Å—Ç—Ä–∞–ª–∏—è, –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã, –®–≤–µ—Ü–∏—è, –®–≤–µ–π—Ü–∞—Ä–∏—è, –ù–æ—Ä–≤–µ–≥–∏—è, –î–∞–Ω–∏—è, –§–∏–Ω–ª—è–Ω–¥–∏—è, –ê–≤—Å—Ç—Ä–∏—è, –ë–µ–ª—å–≥–∏—è, –ò—Ä–ª–∞–Ω–¥–∏—è, –°–∏–Ω–≥–∞–ø—É—Ä, –ì–æ–Ω–∫–æ–Ω–≥, –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è, –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è</p>
                        <div class="h4 text-primary">100%</div>
                        <small>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-2 mb-2">Tier 2</span>
                        <h5>–†–∞–∑–≤–∏–≤–∞—é—â–∏–µ—Å—è —Å—Ç—Ä–∞–Ω—ã</h5>
                        <p class="text-muted">–ò—Ç–∞–ª–∏—è, –ò—Å–ø–∞–Ω–∏—è, –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è, –ì—Ä–µ—Ü–∏—è, –ü–æ–ª—å—à–∞, –ß–µ—Ö–∏—è, –í–µ–Ω–≥—Ä–∏—è, –°–ª–æ–≤–∞–∫–∏—è, –°–ª–æ–≤–µ–Ω–∏—è, –≠—Å—Ç–æ–Ω–∏—è, –õ–∞—Ç–≤–∏—è, –õ–∏—Ç–≤–∞, –ë—Ä–∞–∑–∏–ª–∏—è, –ò–Ω–¥–∏—è, –†–æ—Å—Å–∏—è, –ú–µ–∫—Å–∏–∫–∞, –¢—É—Ä—Ü–∏—è, –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞, –ß–∏–ª–∏, –ö–æ–ª—É–º–±–∏—è, –ü–µ—Ä—É, –í–µ–Ω–µ—Å—É—ç–ª–∞, –£—Ä—É–≥–≤–∞–π, –≠–∫–≤–∞–¥–æ—Ä, –ë–æ–ª–∏–≤–∏—è, –ü–∞—Ä–∞–≥–≤–∞–π, –Æ–ê–†</p>
                        <div class="h4 text-warning">85%</div>
                        <small>-15% –æ—Ç –±–∞–∑–æ–≤–æ–π</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-3 mb-2">Tier 3</span>
                        <h5>–≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã</h5>
                        <p class="text-muted">–ù–∏–≥–µ—Ä–∏—è, –ö–µ–Ω–∏—è, –ì–∞–Ω–∞, –£–≥–∞–Ω–¥–∞, –¢–∞–Ω–∑–∞–Ω–∏—è, –≠—Ñ–∏–æ–ø–∏—è, –ú–æ–∑–∞–º–±–∏–∫, –ó–∏–º–±–∞–±–≤–µ, –ó–∞–º–±–∏—è, –ú–∞–ª–∞–≤–∏, –ë–æ—Ç—Å–≤–∞–Ω–∞, –ù–∞–º–∏–±–∏—è, –í—å–µ—Ç–Ω–∞–º, –§–∏–ª–∏–ø–ø–∏–Ω—ã, –ï–≥–∏–ø–µ—Ç, –ü–∞–∫–∏—Å—Ç–∞–Ω, –ë–∞–Ω–≥–ª–∞–¥–µ—à, –®—Ä–∏-–õ–∞–Ω–∫–∞, –ù–µ–ø–∞–ª, –ú—å—è–Ω–º–∞, –ö–∞–º–±–æ–¥–∂–∞, –õ–∞–æ—Å, –ú–æ–Ω–≥–æ–ª–∏—è</p>
                        <div class="h4 text-danger">70%</div>
                        <small>-30% –æ—Ç –±–∞–∑–æ–≤–æ–π</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-difficult mb-2">–°–ª–æ–∂–Ω—ã–µ</span>
                        <h5>–°–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã</h5>
                        <p class="text-muted">–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω, –ò—Ä–∞–Ω, –ò—Ä–∞–∫, –°–∏—Ä–∏—è, –õ–∏–≤–∞–Ω, –ò–æ—Ä–¥–∞–Ω–∏—è, –ü–∞–ª–µ—Å—Ç–∏–Ω–∞, –ô–µ–º–µ–Ω, –û–º–∞–Ω, –ö—É–≤–µ–π—Ç, –ö–∞—Ç–∞—Ä, –ë–∞—Ö—Ä–µ–π–Ω, –û–ê–≠, –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è, –£–∫—Ä–∞–∏–Ω–∞</p>
                        <div class="h4 text-dark">100% + 30%</div>
                        <small>–°–ª–æ–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–∞—Å—á–µ—Ç–∞ -->
        <div class="form-section">
            <form id="calcForm" class="form-card">
                <div class="row">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="col-lg-6">
                        <h4><i class="bi bi-eye"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                        
                        <div class="mb-3">
                            <label for="views_mln" class="form-label">
                                <strong>–û–±—ä–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–º–ª–Ω)</strong>
                                <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º: 15 –º–ª–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"></i>
                            </label>
                            <input type="number" class="form-control" id="views_mln" name="views_mln" min="15" max="1000" step="1" value="15" required>
                            <input type="range" class="form-range mt-2" id="views_slider" min="15" max="1000" step="1" value="15">
                            <small class="text-muted">–û—Ç 15 –¥–æ 1000 –º–ª–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</strong></label>
                            <div class="d-flex flex-wrap gap-2 gap-md-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="platform_instagram" name="platform_instagram" checked>
                                    <label class="form-check-label" for="platform_instagram">
                                        <i class="bi bi-instagram text-danger"></i> Instagram
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="platform_tiktok" name="platform_tiktok">
                                    <label class="form-check-label" for="platform_tiktok">
                                        <i class="bi bi-tiktok text-dark"></i> TikTok
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="platform_youtube_shorts" name="platform_youtube_shorts">
                                    <label class="form-check-label" for="platform_youtube_shorts">
                                        <i class="bi bi-youtube text-danger"></i> YouTube Shorts <span class="badge bg-warning">+15%</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="currency" class="form-label"><strong>–í–∞–ª—é—Ç–∞</strong></label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="USD" selected>–î–æ–ª–ª–∞—Ä—ã ($)</option>
                                <option value="RUB">–†—É–±–ª–∏ (‚ÇΩ)</option>
                                <option value="EUR">–ï–≤—Ä–æ (‚Ç¨)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="countries" class="form-label"><strong>–í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω</strong></label>
                            <div class="country-select border rounded p-2">
                                <div class="mb-2">
                                    <strong class="text-primary">Tier 1 - –ü—Ä–µ–º–∏—É–º —Å—Ç—Ä–∞–Ω—ã</strong>
                                    <div class="country-option" data-country="USA" data-tier="1">üá∫üá∏ –°–®–ê</div>
                                    <div class="country-option" data-country="UK" data-tier="1">üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</div>
                                    <div class="country-option" data-country="DE" data-tier="1">üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è</div>
                                    <div class="country-option" data-country="FR" data-tier="1">üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è</div>
                                    <div class="country-option" data-country="JP" data-tier="1">üáØüáµ –Ø–ø–æ–Ω–∏—è</div>
                                    <div class="country-option" data-country="CA" data-tier="1">üá®üá¶ –ö–∞–Ω–∞–¥–∞</div>
                                    <div class="country-option" data-country="AU" data-tier="1">üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è</div>
                                    <div class="country-option" data-country="NL" data-tier="1">üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã</div>
                                    <div class="country-option" data-country="SE" data-tier="1">üá∏üá™ –®–≤–µ—Ü–∏—è</div>
                                    <div class="country-option" data-country="CH" data-tier="1">üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è</div>
                                    <div class="country-option" data-country="NO" data-tier="1">üá≥üá¥ –ù–æ—Ä–≤–µ–≥–∏—è</div>
                                    <div class="country-option" data-country="DK" data-tier="1">üá©üá∞ –î–∞–Ω–∏—è</div>
                                    <div class="country-option" data-country="FI" data-tier="1">üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è</div>
                                    <div class="country-option" data-country="AT" data-tier="1">üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è</div>
                                    <div class="country-option" data-country="BE" data-tier="1">üáßüá™ –ë–µ–ª—å–≥–∏—è</div>
                                    <div class="country-option" data-country="IE" data-tier="1">üáÆüá™ –ò—Ä–ª–∞–Ω–¥–∏—è</div>
                                    <div class="country-option" data-country="SG" data-tier="1">üá∏üá¨ –°–∏–Ω–≥–∞–ø—É—Ä</div>
                                    <div class="country-option" data-country="HK" data-tier="1">üá≠üá∞ –ì–æ–Ω–∫–æ–Ω–≥</div>
                                    <div class="country-option" data-country="KR" data-tier="1">üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</div>
                                    <div class="country-option" data-country="NZ" data-tier="1">üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è</div>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-warning">Tier 2 - –†–∞–∑–≤–∏–≤–∞—é—â–∏–µ—Å—è —Å—Ç—Ä–∞–Ω—ã</strong>
                                    <div class="country-option" data-country="IT" data-tier="2">üáÆüáπ –ò—Ç–∞–ª–∏—è</div>
                                    <div class="country-option" data-country="ES" data-tier="2">üá™üá∏ –ò—Å–ø–∞–Ω–∏—è</div>
                                    <div class="country-option" data-country="PT" data-tier="2">üáµüáπ –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è</div>
                                    <div class="country-option" data-country="GR" data-tier="2">üá¨üá∑ –ì—Ä–µ—Ü–∏—è</div>
                                    <div class="country-option" data-country="PL" data-tier="2">üáµüá± –ü–æ–ª—å—à–∞</div>
                                    <div class="country-option" data-country="CZ" data-tier="2">üá®üáø –ß–µ—Ö–∏—è</div>
                                    <div class="country-option" data-country="HU" data-tier="2">üá≠üá∫ –í–µ–Ω–≥—Ä–∏—è</div>
                                    <div class="country-option" data-country="SK" data-tier="2">üá∏üá∞ –°–ª–æ–≤–∞–∫–∏—è</div>
                                    <div class="country-option" data-country="SI" data-tier="2">üá∏üáÆ –°–ª–æ–≤–µ–Ω–∏—è</div>
                                    <div class="country-option" data-country="EE" data-tier="2">üá™üá™ –≠—Å—Ç–æ–Ω–∏—è</div>
                                    <div class="country-option" data-country="LV" data-tier="2">üá±üáª –õ–∞—Ç–≤–∏—è</div>
                                    <div class="country-option" data-country="LT" data-tier="2">üá±üáπ –õ–∏—Ç–≤–∞</div>
                                    <div class="country-option" data-country="BR" data-tier="2">üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è</div>
                                    <div class="country-option" data-country="IN" data-tier="2">üáÆüá≥ –ò–Ω–¥–∏—è</div>
                                    <div class="country-option" data-country="RU" data-tier="2">üá∑üá∫ –†–æ—Å—Å–∏—è</div>
                                    <div class="country-option" data-country="MX" data-tier="2">üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞</div>
                                    <div class="country-option" data-country="TR" data-tier="2">üáπüá∑ –¢—É—Ä—Ü–∏—è</div>
                                    <div class="country-option" data-country="AR" data-tier="2">üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞</div>
                                    <div class="country-option" data-country="CL" data-tier="2">üá®üá± –ß–∏–ª–∏</div>
                                    <div class="country-option" data-country="CO" data-tier="2">üá®üá¥ –ö–æ–ª—É–º–±–∏—è</div>
                                    <div class="country-option" data-country="PE" data-tier="2">üáµüá™ –ü–µ—Ä—É</div>
                                    <div class="country-option" data-country="VE" data-tier="2">üáªüá™ –í–µ–Ω–µ—Å—É—ç–ª–∞</div>
                                    <div class="country-option" data-country="UY" data-tier="2">üá∫üáæ –£—Ä—É–≥–≤–∞–π</div>
                                    <div class="country-option" data-country="EC" data-tier="2">üá™üá® –≠–∫–≤–∞–¥–æ—Ä</div>
                                    <div class="country-option" data-country="BO" data-tier="2">üáßüá¥ –ë–æ–ª–∏–≤–∏—è</div>
                                    <div class="country-option" data-country="PY" data-tier="2">üáµüáæ –ü–∞—Ä–∞–≥–≤–∞–π</div>
                                    <div class="country-option" data-country="ZA" data-tier="2">üáøüá¶ –Æ–ê–†</div>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-danger">Tier 3 - –≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã</strong>
                                    <div class="country-option" data-country="NG" data-tier="3">üá≥üá¨ –ù–∏–≥–µ—Ä–∏—è</div>
                                    <div class="country-option" data-country="KE" data-tier="3">üá∞üá™ –ö–µ–Ω–∏—è</div>
                                    <div class="country-option" data-country="GH" data-tier="3">üá¨üá≠ –ì–∞–Ω–∞</div>
                                    <div class="country-option" data-country="UG" data-tier="3">üá∫üá¨ –£–≥–∞–Ω–¥–∞</div>
                                    <div class="country-option" data-country="TZ" data-tier="3">üáπüáø –¢–∞–Ω–∑–∞–Ω–∏—è</div>
                                    <div class="country-option" data-country="ET" data-tier="3">üá™üáπ –≠—Ñ–∏–æ–ø–∏—è</div>
                                    <div class="country-option" data-country="MZ" data-tier="3">üá≤üáø –ú–æ–∑–∞–º–±–∏–∫</div>
                                    <div class="country-option" data-country="ZW" data-tier="3">üáøüáº –ó–∏–º–±–∞–±–≤–µ</div>
                                    <div class="country-option" data-country="ZM" data-tier="3">üáøüá≤ –ó–∞–º–±–∏—è</div>
                                    <div class="country-option" data-country="MW" data-tier="3">üá≤üáº –ú–∞–ª–∞–≤–∏</div>
                                    <div class="country-option" data-country="BW" data-tier="3">üáßüáº –ë–æ—Ç—Å–≤–∞–Ω–∞</div>
                                    <div class="country-option" data-country="NAM" data-tier="3">üá≥üá¶ –ù–∞–º–∏–±–∏—è</div>
                                    <div class="country-option" data-country="VN" data-tier="3">üáªüá≥ –í—å–µ—Ç–Ω–∞–º</div>
                                    <div class="country-option" data-country="PH" data-tier="3">üáµüá≠ –§–∏–ª–∏–ø–ø–∏–Ω—ã</div>
                                    <div class="country-option" data-country="EG" data-tier="3">üá™üá¨ –ï–≥–∏–ø–µ—Ç</div>
                                    <div class="country-option" data-country="PK" data-tier="3">üáµüá∞ –ü–∞–∫–∏—Å—Ç–∞–Ω</div>
                                    <div class="country-option" data-country="BD" data-tier="3">üáßüá© –ë–∞–Ω–≥–ª–∞–¥–µ—à</div>
                                    <div class="country-option" data-country="LK" data-tier="3">üá±üá∞ –®—Ä–∏-–õ–∞–Ω–∫–∞</div>
                                    <div class="country-option" data-country="NP" data-tier="3">üá≥üáµ –ù–µ–ø–∞–ª</div>
                                    <div class="country-option" data-country="MM" data-tier="3">üá≤üá≤ –ú—å—è–Ω–º–∞</div>
                                    <div class="country-option" data-country="KH" data-tier="3">üá∞üá≠ –ö–∞–º–±–æ–¥–∂–∞</div>
                                    <div class="country-option" data-country="LA" data-tier="3">üá±üá¶ –õ–∞–æ—Å</div>
                                    <div class="country-option" data-country="MN" data-tier="3">üá≤üá≥ –ú–æ–Ω–≥–æ–ª–∏—è</div>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-dark">–°–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã</strong>
                                    <div class="country-option" data-country="AF" data-tier="difficult">üá¶üá´ –ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω</div>
                                    <div class="country-option" data-country="IR" data-tier="difficult">üáÆüá∑ –ò—Ä–∞–Ω</div>
                                    <div class="country-option" data-country="IQ" data-tier="difficult">üáÆüá∂ –ò—Ä–∞–∫</div>
                                    <div class="country-option" data-country="SY" data-tier="difficult">üá∏üáæ –°–∏—Ä–∏—è</div>
                                    <div class="country-option" data-country="LB" data-tier="difficult">üá±üáß –õ–∏–≤–∞–Ω</div>
                                    <div class="country-option" data-country="JO" data-tier="difficult">üáØüá¥ –ò–æ—Ä–¥–∞–Ω–∏—è</div>
                                    <div class="country-option" data-country="PS" data-tier="difficult">üáµüá∏ –ü–∞–ª–µ—Å—Ç–∏–Ω–∞</div>
                                    <div class="country-option" data-country="YE" data-tier="difficult">üáæüá™ –ô–µ–º–µ–Ω</div>
                                    <div class="country-option" data-country="OM" data-tier="difficult">üá¥üá≤ –û–º–∞–Ω</div>
                                    <div class="country-option" data-country="KW" data-tier="difficult">üá∞üáº –ö—É–≤–µ–π—Ç</div>
                                    <div class="country-option" data-country="QA" data-tier="difficult">üá∂üá¶ –ö–∞—Ç–∞—Ä</div>
                                    <div class="country-option" data-country="BH" data-tier="difficult">üáßüá≠ –ë–∞—Ö—Ä–µ–π–Ω</div>
                                    <div class="country-option" data-country="AE" data-tier="difficult">üá¶üá™ –û–ê–≠</div>
                                    <div class="country-option" data-country="SA" data-tier="difficult">üá∏üá¶ –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è</div>
                                    <div class="country-option" data-country="UA" data-tier="difficult">üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞</div>
                                </div>
                            </div>
                            <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è</small>
                        </div>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="col-lg-6">
                        <h4><i class="bi bi-tags"></i> –°–∫–∏–¥–∫–∏ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</h4>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>–°–∫–∏–¥–∫–∏</strong></label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="own_badge" name="own_badge">
                                <label class="form-check-label" for="own_badge">–°–≤–æ–π –±–µ–π–¥–∂ (-3%)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="own_content" name="own_content">
                                <label class="form-check-label" for="own_content">–°–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (-15%)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="pilot" name="pilot">
                                <label class="form-check-label" for="pilot">–ü–∏–ª–æ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (-10%)</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="vip_discount" class="form-label"><strong>VIP —Å–∫–∏–¥–∫–∞</strong></label>
                            <select class="form-select" id="vip_discount" name="vip_discount">
                                <option value="0">0%</option>
                                <option value="3">3%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                            </select>
                        </div>

                        <h4><i class="bi bi-plus-circle"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h4>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="difficult_country" name="difficult_country">
                            <label class="form-check-label" for="difficult_country">–°–ª–æ–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ (+30%)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="urgency" name="urgency">
                            <label class="form-check-label" for="urgency">–°—Ä–æ—á–Ω–æ—Å—Ç—å (+40%)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="peak_season" name="peak_season">
                            <label class="form-check-label" for="peak_season">–ü–∏–∫–æ–≤—ã–π —Å–µ–∑–æ–Ω (+25%)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="exclusive_content" name="exclusive_content">
                            <label class="form-check-label" for="exclusive_content">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (+35%)</label>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-primary" id="calculateBtn">
                        <i class="bi bi-calculator"></i> –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
                    </button>
                    <button type="button" class="btn btn-secondary" id="resetForm">
                        <i class="bi bi-arrow-clockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="result-section" id="resultBlock" style="display:none;">
            <h3 class="text-center mb-4"><i class="bi bi-graph-up"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h3>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-primary">–û–±—ä–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                        <div class="h3" id="res_views">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-success">–¶–µ–Ω–∞ –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                        <div class="h3" id="res_cpv">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-warning">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ —Å—Ç—Ä–∞–Ω–µ</div>
                        <div class="h3" id="res_multiplier">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-info">–†—ã–Ω–æ—á–Ω–∞—è —Å–∫–∏–¥–∫–∞</div>
                        <div class="h3" id="res_market_discount">-</div>
                    </div>
                </div>
            </div>
            
            <!-- –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è —Å —Ü–µ–Ω–∞–º–∏ –ø–æ CPM –∏ –∏—Ç–æ–≥–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏ -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-primary">CPM (–∑–∞ 1000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)</div>
                        <div class="h3" id="res_cpm">-</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-success">–¶–µ–Ω–∞ –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ —Å–∫–∏–¥–∫–∞–º–∏</div>
                        <div class="h3" id="res_cpv_final">-</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-warning">CPM —Å–æ —Å–∫–∏–¥–∫–∞–º–∏</div>
                        <div class="h3" id="res_cpm_final">-</div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4" id="platform_multiplier_row" style="display:none;">
                <div class="col-md-6 offset-md-3">
                    <div class="text-center">
                        <div class="h5 text-danger" id="res_platform_multiplier_label">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</div>
                        <div class="h3" id="res_platform_multiplier">-</div>
                    </div>
                </div>
            </div>

            <div class="accordion mb-4" id="resultAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMarkups">
                            <i class="bi bi-plus-circle"></i> –ù–∞–¥–±–∞–≤–∫–∏
                        </button>
                    </h2>
                    <div id="collapseMarkups" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <div id="res_markups"></div>
                            <div class="mt-2">
                                <strong>–û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞–¥–±–∞–≤–æ–∫: <span id="res_markup_amount">-</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDiscounts">
                            <i class="bi bi-dash-circle"></i> –°–∫–∏–¥–∫–∏
                        </button>
                    </h2>
                    <div id="collapseDiscounts" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div id="res_discounts"></div>
                            <div class="mt-2">
                                <strong>–û–±—â–∞—è —Å—É–º–º–∞ —Å–∫–∏–¥–æ–∫: <span id="res_discount_amount">-</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="final-cost">
                <div class="h4 mb-2">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                <div class="h1" id="res_final_cost">-</div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-success me-2" id="saveCalc">
                    <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç
                </button>
                <button class="btn btn-info me-2" id="copySummary">
                    <i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <a class="btn btn-primary me-2" id="downloadExcel" href="#" style="display:none;" data-loading-text="–ì–æ—Ç–æ–≤–∏–º Excel...">
                    <span class="btn-label"><i class="bi bi-file-earmark-excel"></i> –°–∫–∞—á–∞—Ç—å Excel</span>
                    <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;"></span>
                </a>
                <a class="btn btn-secondary" href="{% url 'cabinet_export_calculations_csv' %}">
                    <i class="bi bi-file-earmark-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ (CSV)
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // Modal for client name after save
        const clientNameModalHtml = `
<div class="modal fade" id="clientNameModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="client_name_input" class="form-label">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞</label>
        <input type="text" class="form-control" id="client_name_input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="client_name_save_btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>`;
        document.addEventListener('DOMContentLoaded', function() {
            // Inject modal once
            const wrapper = document.createElement('div');
            wrapper.innerHTML = clientNameModalHtml;
            document.body.appendChild(wrapper);
        });
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ PHP –≤–µ—Ä—Å–∏–∏)
        const BASE_TARIFFS = {
            15000000: 0.055,
            30000000: 0.050,
            50000000: 0.045,
            100000000: 0.040
        };
        
        const COUNTRY_MULTIPLIERS = {
            1: 1.0,    // Tier1 - –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
            2: 0.85,   // Tier2 - —Å–∫–∏–¥–∫–∞ 15%
            3: 0.7,    // Tier3 - —Å–∫–∏–¥–∫–∞ 30%
            'difficult': 1.0  // –°–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã - –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (100%)
        };
        
        const MARKET_DISCOUNTS = {
            50000000: 5,      // 50 –º–ª–Ω+ - —Å–∫–∏–¥–∫–∞ 5%
            100000000: 10,    // 100 –º–ª–Ω+ - —Å–∫–∏–¥–∫–∞ 10%
            200000000: 15,    // 200 –º–ª–Ω+ - —Å–∫–∏–¥–∫–∞ 15%
            500000000: 20     // 500 –º–ª–Ω+ - —Å–∫–∏–¥–∫–∞ 20%
        };
        
        const DISCOUNTS = {
            'own_badge': 3,
            'own_content': 15,
            'pilot': 10
        };
        
        const MARKUPS = {
            'difficult_country': 30,
            'urgency': 40,
            'peak_season': 25,
            'exclusive_content': 35
        };
        
        // –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –ø–æ –¶–ë –†–§ (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞ 2025 –≥–æ–¥)
        const usdToRub = 92.5;  // 1 USD = 92.5 RUB
        const eurToRub = 100.8; // 1 EUR = 100.8 RUB
        
        // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
        let selectedCountries = [];
        
        function getCookie(name){
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeCountrySelection();
            initializeEventHandlers();
            calculate();
        });
        
        function initializeCountrySelection() {
            document.querySelectorAll('.country-option').forEach(element => {
                element.addEventListener('click', function() {
                    const country = this.dataset.country;
                    const tier = this.dataset.tier;
                    
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedCountries = selectedCountries.filter(c => c.code !== country);
                    } else {
                        this.classList.add('selected');
                        selectedCountries.push({ code: country, tier: tier });
                    }
                    
                    calculate();
                });
            });
        }
        
        function initializeEventHandlers() {
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
            document.getElementById('views_mln').addEventListener('input', function() {
                document.getElementById('views_slider').value = this.value;
                calculate();
            });
            
            document.getElementById('views_slider').addEventListener('input', function() {
                document.getElementById('views_mln').value = this.value;
                calculate();
            });
            
            // –ü–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±—ã—Ö –ø–æ–ª–µ–π
            document.querySelectorAll('#calcForm input, #calcForm select').forEach(element => {
                element.addEventListener('change', calculate);
            });
            
            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('calculateBtn').addEventListener('click', calculate);
            document.getElementById('resetForm').addEventListener('click', resetForm);
            document.getElementById('saveCalc').addEventListener('click', saveCalculation);
            document.getElementById('copySummary').addEventListener('click', copySummary);
        }
        
        function calculate() {
            const views_mln = parseFloat(document.getElementById('views_mln').value) || 0;
            const views = views_mln * 1000000;
            
            if (views_mln < 15) {
                document.getElementById('resultBlock').style.display = 'none';
                return;
            }
            
            if (!document.getElementById('platform_instagram').checked && 
                !document.getElementById('platform_tiktok').checked && 
                !document.getElementById('platform_youtube_shorts').checked) {
                return;
            }
            
            // –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
            const basePrice = getBasePrice(views);
            const baseCost = views * basePrice;
            
            // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
            const countryMultiplier = getCountryMultiplier();
            const adjustedCost = baseCost * countryMultiplier;
            
            // –†—ã–Ω–æ—á–Ω–∞—è —Å–∫–∏–¥–∫–∞
            const marketDiscount = getMarketDiscount(views);
            const marketDiscountAmount = adjustedCost * (marketDiscount / 100);
            const costAfterMarketDiscount = adjustedCost - marketDiscountAmount;
            
            // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
            const platformMultiplier = getPlatformMultiplier();
            const costAfterPlatform = costAfterMarketDiscount * platformMultiplier;
            
            // –°–∫–∏–¥–∫–∏
            const { discountPercent, discountList } = calculateDiscounts();
            const discountAmount = costAfterPlatform * (discountPercent / 100);
            const costAfterDiscounts = costAfterPlatform - discountAmount;
            
            // –ù–∞–¥–±–∞–≤–∫–∏
            const { markupPercent, markupList } = calculateMarkups();
            const markupAmount = costAfterDiscounts * (markupPercent / 100);
            const finalCost = costAfterDiscounts + markupAmount;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç—ã
            const currency = document.getElementById('currency').value;
            const { symbol, convertedCost } = convertCurrency(finalCost, currency);
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            displayResults(views_mln, basePrice, countryMultiplier, marketDiscount, 
                         platformMultiplier, discountAmount, markupAmount, convertedCost, symbol, 
                         discountList, markupList, currency);
        }
        
        function getBasePrice(views) {
            if (views >= 100000000) return 0.040;
            if (views >= 50000000) return 0.045;
            if (views >= 30000000) return 0.050;
            if (views >= 15000000) return 0.055;
            return 0.055;
        }
        
        function getCountryMultiplier() {
            if (selectedCountries.length === 0) return 1.0;
            
            const avgTier = selectedCountries.reduce((sum, country) => {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —á–∏—Å–ª–æ–≤—ã–µ, —Ç–∞–∫ –∏ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ —Ç–∏—Ä—ã
                if (country.tier === 'difficult') return sum + 4; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
                return sum + parseInt(country.tier);
            }, 0) / selectedCountries.length;
            
            const tier = Math.round(avgTier);
            
            // –ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö —Ç–∏—Ä–æ–≤
            if (tier === 4) return COUNTRY_MULTIPLIERS['difficult']; // –°–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
            return COUNTRY_MULTIPLIERS[tier] || 1.0;
        }
        
        function getMarketDiscount(views) {
            const sortedDiscounts = Object.entries(MARKET_DISCOUNTS).sort((a, b) => parseInt(b[0]) - parseInt(a[0]));
            for (const [minViews, discount] of sortedDiscounts) {
                if (views >= parseInt(minViews)) {
                    return discount;
                }
            }
            return 0;
        }
        
        function getPlatformMultiplier() {
            let multiplier = 1.0;
            
            if (document.getElementById('platform_youtube_shorts').checked) {
                multiplier = 1.15; // YouTube Shorts +15%
            }
            
            return multiplier;
        }
        
        function calculateDiscounts() {
            let totalDiscount = 0;
            let discountList = [];
            
            for (const [key, discount] of Object.entries(DISCOUNTS)) {
                const element = document.getElementById(key);
                if (element && element.checked) {
                    totalDiscount += discount;
                    discountList.push(`<div class="d-flex justify-content-between"><span>${getDiscountName(key)}</span><span class="text-success">-${discount}%</span></div>`);
                }
            }
            
            const vipDiscount = parseFloat(document.getElementById('vip_discount').value) || 0;
            if (vipDiscount > 0) {
                totalDiscount += vipDiscount;
                discountList.push(`<div class="d-flex justify-content-between"><span>VIP —Å–∫–∏–¥–∫–∞</span><span class="text-success">-${vipDiscount}%</span></div>`);
            }
            
            return { discountPercent: totalDiscount, discountList };
        }
        
        function calculateMarkups() {
            let totalMarkup = 0;
            let markupList = [];
            
            for (const [key, markup] of Object.entries(MARKUPS)) {
                const element = document.getElementById(key);
                if (element && element.checked) {
                    totalMarkup += markup;
                    markupList.push(`<div class="d-flex justify-content-between"><span>${getMarkupName(key)}</span><span class="text-danger">+${markup}%</span></div>`);
                }
            }
            
            return { markupPercent: totalMarkup, markupList };
        }
        
        function getDiscountName(key) {
            const names = {
                'own_badge': '–°–≤–æ–π –±–µ–π–¥–∂',
                'own_content': '–°–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'pilot': '–ü–∏–ª–æ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç'
            };
            return names[key] || key;
        }
        
        function getMarkupName(key) {
            const names = {
                'difficult_country': '–°–ª–æ–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞',
                'urgency': '–°—Ä–æ—á–Ω–æ—Å—Ç—å',
                'peak_season': '–ü–∏–∫–æ–≤—ã–π —Å–µ–∑–æ–Ω',
                'exclusive_content': '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç'
            };
            return names[key] || key;
        }
        
        function convertCurrency(amount, currency) {
            let symbol = ' ‚ÇΩ';
            let convertedAmount = amount;
            
            if (currency === 'USD') {
                convertedAmount = amount / usdToRub;
                symbol = ' $';
            } else if (currency === 'EUR') {
                convertedAmount = amount / eurToRub;
                symbol = ' ‚Ç¨';
            }
            
            return { symbol, convertedCost: convertedAmount };
        }
        
        function displayResults(views_mln, basePrice, countryMultiplier, marketDiscount, 
                               platformMultiplier, discountAmount, markupAmount, finalCost, symbol, 
                               discountList, markupList, currency) {
            
            document.getElementById('res_views').textContent = views_mln.toLocaleString('ru-RU') + ' –º–ª–Ω';
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
            const { symbol: cpvSymbol, convertedCost: cpvCost } = convertCurrency(basePrice, currency);
            document.getElementById('res_cpv').textContent = cpvCost.toFixed(4) + cpvSymbol;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º CPM (—Ü–µ–Ω–∞ –∑–∞ 1000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)
            const cpm = cpvCost * 1000;
            document.getElementById('res_cpm').textContent = cpm.toFixed(2) + cpvSymbol;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É –∑–∞ 1 –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ –≤—Å–µ–º–∏ —Å–∫–∏–¥–∫–∞–º–∏ –∏ –Ω–∞–¥–±–∞–≤–∫–∞–º–∏
            const finalCostPerView = finalCost / (views_mln * 1000000);
            document.getElementById('res_cpv_final').textContent = finalCostPerView.toFixed(4) + symbol;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π CPM —Å–æ —Å–∫–∏–¥–∫–∞–º–∏
            const finalCpm = finalCostPerView * 1000;
            document.getElementById('res_cpm_final').textContent = finalCpm.toFixed(2) + symbol;
            
            document.getElementById('res_multiplier').textContent = (countryMultiplier * 100).toFixed(0) + '%';
            document.getElementById('res_market_discount').textContent = marketDiscount + '%';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–Ω–æ–∂–∏—Ç–µ–ª–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            if (platformMultiplier > 1.0) {
                document.getElementById('res_platform_multiplier').textContent = '+' + ((platformMultiplier - 1) * 100).toFixed(0) + '%';
                document.getElementById('platform_multiplier_row').style.display = 'block';
            } else {
                document.getElementById('platform_multiplier_row').style.display = 'none';
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—É–º–º—ã –Ω–∞–¥–±–∞–≤–æ–∫ –∏ —Å–∫–∏–¥–æ–∫ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
            const { symbol: markupSymbol, convertedCost: markupConverted } = convertCurrency(markupAmount, currency);
            const { symbol: discountSymbol, convertedCost: discountConverted } = convertCurrency(discountAmount, currency);
            
            document.getElementById('res_markup_amount').textContent = markupConverted.toFixed(2) + markupSymbol;
            document.getElementById('res_discount_amount').textContent = discountConverted.toFixed(2) + discountSymbol;
            document.getElementById('res_final_cost').textContent = finalCost.toFixed(2) + symbol;
            
            document.getElementById('res_markups').innerHTML = markupList.length > 0 ? markupList.join('') : '<div class="text-muted">–ù–µ—Ç –Ω–∞–¥–±–∞–≤–æ–∫</div>';
            document.getElementById('res_discounts').innerHTML = discountList.length > 0 ? discountList.join('') : '<div class="text-muted">–ù–µ—Ç —Å–∫–∏–¥–æ–∫</div>';
            
            document.getElementById('resultBlock').style.display = 'block';
        }
        
        function resetForm() {
            document.getElementById('calcForm').reset();
            document.getElementById('views_slider').value = 15;
            document.querySelectorAll('.country-option').forEach(el => el.classList.remove('selected'));
            selectedCountries = [];
            document.getElementById('resultBlock').style.display = 'none';
            calculate();
        }
        
        async function saveCalculation() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            const platforms = [];
            if (document.getElementById('platform_instagram').checked) platforms.push('instagram');
            if (document.getElementById('platform_tiktok').checked) platforms.push('tiktok');
            if (document.getElementById('platform_youtube_shorts').checked) platforms.push('youtube_shorts');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä–∞–Ω—É –¥–ª—è API (–ø–µ—Ä–≤–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è)
            const primaryCountry = selectedCountries.length > 0 ? selectedCountries[0].code : 'USA';
            
            const calculationData = {
                volume_millions: parseFloat(document.getElementById('views_mln').value) || 0,
                platform: platforms.length > 0 ? platforms[0] : 'instagram', // –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è API
                platforms: platforms, // –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                country: primaryCountry, // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ –¥–ª—è API
                countries: selectedCountries, // –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
                currency: document.getElementById('currency').value,
                own_badge: document.getElementById('own_badge').checked,
                own_content: document.getElementById('own_content').checked,
                pilot: document.getElementById('pilot').checked,
                vip_percent: parseInt(document.getElementById('vip_discount').value) / 100.0 || 0,
                urgent: document.getElementById('urgency').checked,
                peak_season: document.getElementById('peak_season').checked,
                exclusive_content: document.getElementById('exclusive_content').checked,
                notes: '–†–∞—Å—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
            };
            
            // Ask for client name via modal, then include it in payload
            const modalEl = document.getElementById('clientNameModal');
            const modal = new bootstrap.Modal(modalEl);
            const inputEl = () => document.getElementById('client_name_input');
            const saveBtn = () => document.getElementById('client_name_save_btn');
            
            const waitForName = () => new Promise(resolve => {
                const handler = async () => {
                    const nameVal = (inputEl().value || '').trim();
                    modal.hide();
                    saveBtn().removeEventListener('click', handler);
                    resolve(nameVal);
                };
                saveBtn().addEventListener('click', handler);
                modal.show();
                inputEl().focus();
            });

            const clientName = await waitForName();
            if (clientName) {
                calculationData.client_name = clientName;
            }

            try {
                const response = await fetch('{% url "cabinet_agency_calc_quote" %}', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(calculationData)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showNotification('–†–∞—Å—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    if (result.calculation_id) {
                        const downloadBtn = document.getElementById('downloadExcel');
                        downloadBtn.href = `/cabinet/download/calculation/${result.calculation_id}/excel/`;
                        downloadBtn.style.display = 'inline-block';
                        // bind loading indicator
                        if (!downloadBtn.dataset.bound) {
                            downloadBtn.addEventListener('click', function(e){
                                const spinner = this.querySelector('.spinner-border');
                                const label = this.querySelector('.btn-label');
                                if (spinner && label) {
                                    spinner.style.display = 'inline-block';
                                    label.textContent = '–ì–æ—Ç–æ–≤–∏–º Excel...';
                                    // Hide spinner after download starts (best effort)
                                    setTimeout(()=>{
                                        spinner.style.display = 'none';
                                        label.innerHTML = '\\u003ci class="bi bi-file-earmark-excel"\\u003e\\u003c/i\\u003e –°–∫–∞—á–∞—Ç—å Excel';
                                    }, 6000);
                                }
                            });
                            downloadBtn.dataset.bound = '1';
                        }
                    }
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        
        function copySummary() {
            const summary = `–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è: ${document.getElementById('res_views').textContent} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${document.getElementById('res_final_cost').textContent}`;
            navigator.clipboard.writeText(summary).then(() => {
                showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }).catch(() => {
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            });
        }
        
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} notification`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
</script>
{% endblock %}
