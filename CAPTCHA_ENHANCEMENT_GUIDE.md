# YouTube Captcha Enhancement Guide

## Обзор

Система решения капчи в YouTube пайплайне была значительно улучшена для повышения надежности и предотвращения блокировок аккаунтов.

## Ключевые улучшения

### 1. Улучшенная детекция капчи
- **Многоуровневая детекция**: JavaScript, DOM и сетевой мониторинг
- **Поддержка различных типов**: reCAPTCHA v2/v3, hCaptcha, стандартные капчи
- **Надежное извлечение site key** с множественными fallback методами

### 2. Многометодный решатель
- **Аудио-вызов** (бесплатный, первый приоритет)
- **RuCaptcha API** (платный, высокая успешность)
- **JavaScript callbacks** для invisible reCAPTCHA
- **Ручное вмешательство** как последний резерв

### 3. Предотвращение 400 ошибок
- **Обязательная 3-секундная задержка** перед отправкой решения
- **Проверка корректности формы** перед submit
- **Детекция ошибок отправки** и graceful handling
- **Улучшенный поиск кнопок** с множественными селекторами

## Настройка

### Переменные окружения

```bash
# RuCaptcha API (опционально, для fallback)
export RUCAPTCHA_API_KEY="your_api_key_here"

# Настройки логирования
export LOG_LEVEL="INFO"
```

### Конфигурация в коде

```python
from uploader.enhanced_captcha_solver import EnhancedCaptchaSolver, CaptchaConfig

# Создание конфигурации
config = CaptchaConfig(
    audio_timeout=30,           # Таймаут для аудио-вызова
    api_timeout=120,            # Таймаут для API
    max_retries=3,              # Максимум попыток
    rucaptcha_api_key=None,     # API ключ (или из env)
    enable_audio_challenge=True, # Включить аудио-вызов
    enable_api_fallback=True,   # Включить API fallback
    submission_delay=3          # Задержка перед отправкой
)

# Использование решателя
solver = EnhancedCaptchaSolver(config)
result = await solver.solve_captcha(page, proxy, user_agent)
```

## Интеграция с YouTube пайплайном

Система автоматически интегрирована в существующий YouTube пайплайн через обновленную функцию `_handle_recaptcha_check` в `uploader/yt_automation.py`.

### Автоматическое использование

Новая система активируется автоматически при обнаружении капчи во время:
- Входа в Google аккаунт
- Навигации в YouTube Studio
- Загрузки видео

### Логирование

Все операции подробно логируются с префиксами:
- `[CAPTCHA_DETECT]` - детекция капчи
- `[CAPTCHA_SOLVER]` - решение капчи
- `[RECAPTCHA_SOLVER]` - аудио-вызов
- `[YT RECAPTCHA]` - интеграция с YouTube

## Тестирование

### Запуск тестов

```bash
# Установка зависимостей (если нужно)
pip install aiohttp aiofiles

# Запуск тестового скрипта
python test_captcha_enhancement.py
```

### Тестирование с реальными аккаунтами

```python
# В вашем коде YouTube автоматизации
from uploader.yt_automation import login_to_google

# Функция автоматически использует новую систему
success = await login_to_google(page, email, password, proxy, user_agent)
```

## Мониторинг и отладка

### Ключевые метрики

1. **Успешность детекции** - процент правильно обнаруженных капч
2. **Успешность решения** - процент успешно решенных капч по методам
3. **Время обработки** - среднее время решения капчи
4. **Частота 400 ошибок** - должна быть близка к нулю

### Отладка проблем

#### Капча не обнаруживается
```python
# Включить детальное логирование
import logging
logging.getLogger().setLevel(logging.DEBUG)

# Проверить детекцию вручную
from uploader.captcha_detection import EnhancedCaptchaDetector
detector = EnhancedCaptchaDetector()
params = await detector.detect_captcha_type(page)
print(f"Detected: {params.captcha_type.value}")
```

#### Аудио-вызов не работает
- Проверить наличие `pydub` и `speech_recognition`
- Убедиться в доступности Google Speech API
- Проверить качество аудио файлов

#### API решение не работает
- Проверить API ключ RuCaptcha
- Убедиться в наличии баланса на аккаунте
- Проверить соответствие IP адресов (proxy)

#### 400 ошибки продолжаются
- Увеличить `submission_delay` в конфигурации
- Проверить корректность извлечения site key
- Убедиться в правильности формы отправки

## Производительность

### Рекомендуемые настройки

```python
# Для быстрой обработки (меньше надежности)
config = CaptchaConfig(
    audio_timeout=20,
    api_timeout=60,
    max_retries=2,
    submission_delay=2
)

# Для максимальной надежности (медленнее)
config = CaptchaConfig(
    audio_timeout=45,
    api_timeout=180,
    max_retries=5,
    submission_delay=5
)
```

### Оптимизация затрат

1. **Используйте аудио-вызов в первую очередь** (бесплатно)
2. **API только как fallback** для сложных случаев
3. **Мониторьте успешность** по методам и аккаунтам
4. **Настройте таймауты** под ваши требования

## Безопасность

### Антидетекция

- Реалистичные задержки между действиями
- Человекоподобные паттерны взаимодействия
- Соответствие IP адресов браузера и API
- Ротация User-Agent строк

### Защита данных

- API ключи только через переменные окружения
- Автоматическая очистка временных файлов
- Отсутствие персистентного хранения решений

## Поддержка

### Известные ограничения

1. **hCaptcha** - базовая поддержка, может потребовать доработка
2. **Invisible reCAPTCHA** - частично реализовано
3. **reCAPTCHA v3** - только через API

### Планы развития

1. Полная поддержка hCaptcha
2. Улучшенная обработка invisible reCAPTCHA
3. Кэширование успешных паттернов
4. Машинное обучение для оптимизации

## Заключение

Новая система решения капчи значительно повышает надежность YouTube пайплайна и снижает риск блокировок аккаунтов. При правильной настройке и мониторинге она обеспечивает высокую успешность прохождения капчи с минимальными затратами.